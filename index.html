<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Medical Insurance Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        .modal-open {
            overflow: hidden !important;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0B1120;
            /* Deep Dark Blue Base */
            color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            height: 100vh;
            /* Fixed height for full app feel */
        }

        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
            transform: translateY(15px);
        }

        .fade-in-delayed {
            animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.1s forwards;
            opacity: 0;
            transform: translateY(15px);
        }

        .slide-up {
            animation: slideUp 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* PREMIUM ANIMATED BACKGROUND */
        .ambient-light {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
            background: #0B1120;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.5;
            animation: float 20s infinite ease-in-out alternate;
        }

        .orb-1 {
            top: -10%;
            left: -10%;
            width: 60vw;
            height: 60vw;
            background: #1D375F;
            /* Secondary Blue */
            animation-delay: 0s;
        }

        .orb-2 {
            bottom: -10%;
            right: -10%;
            width: 70vw;
            height: 70vw;
            background: #B99A4F;
            /* Primary Gold */
            opacity: 0.2;
            animation-delay: -5s;
        }

        .orb-3 {
            top: 40%;
            left: 40%;
            width: 40vw;
            height: 40vw;
            background: #1D375F;
            opacity: 0.3;
            animation-delay: -10s;
        }

        @keyframes float {
            0% {
                transform: translate(0, 0) scale(1);
            }

            100% {
                transform: translate(30px, 50px) scale(1.1);
            }
        }

        /* Chat Bubbles */
        .chat-bubble {
            max-width: 90%;
            width: fit-content;
            padding: 14px 18px;
            border-radius: 20px;
            font-size: 0.95rem;
            line-height: 1.6;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        @media (min-width: 768px) {
            .chat-bubble {
                max-width: 60%;
            }
        }

        .chat-user {
            background: linear-gradient(135deg, #B99A4F 0%, #8A7137 100%);
            /* Gold Gradient */
            color: white;
            border-bottom-right-radius: 4px;
            align-self: flex-end;
            margin-left: auto;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .chat-bot {
            background-color: rgba(255, 255, 255, 0.95);
            color: #1e293b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom-left-radius: 4px;
            align-self: flex-start;
        }

        /* SEAMLESS HEADER */
        .seamless-header {
            /* No border, subtle gradient fade only */
            background: linear-gradient(to bottom, rgba(11, 17, 32, 0.8) 0%, rgba(11, 17, 32, 0) 100%);
            backdrop-filter: blur(2px);
        }

        /* Input Container Gradient Mask */
        .input-container-glass {
            background: linear-gradient(to top, rgba(11, 17, 32, 1) 20%, rgba(11, 17, 32, 0.8) 80%, rgba(11, 17, 32, 0) 100%);
            backdrop-filter: blur(8px);
        }

        /* Typing Indicator */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
            height: 6px;
            width: 6px;
            background-color: #94a3b8;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* Gold Button Class */
        .btn-gold {
            background: linear-gradient(135deg, #B99A4F 0%, #967d40 100%);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px -3px rgba(185, 154, 79, 0.4);
        }

        .btn-gold:active {
            transform: scale(0.98);
        }

        .btn-gold:hover {
            filter: brightness(1.1);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#FDFBF6',
                            100: '#F7F3E6',
                            200: '#EBE2C8',
                            300: '#DFD0AA',
                            400: '#D3BE8C',
                            500: '#B99A4F', // Primary Gold
                            600: '#A68842',
                            700: '#8A7137',
                            900: '#1D375F',
                        },
                        secondary: {
                            DEFAULT: '#1D375F', // Secondary Blue
                            light: '#2a4d82',
                            dark: '#0B1120'
                        }
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0, 0, 0, 0.2)',
                        'glow': '0 0 30px rgba(185, 154, 79, 0.4)'
                    }
                }
            }
        }
    </script>
</head>

<body class="h-screen w-full flex flex-col overflow-hidden">

    <div class="ambient-light">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <header id="header"
        class="fixed top-0 left-0 right-0 h-20 seamless-header z-50 flex items-center justify-between px-6 md:px-12 transition-all duration-300">
        <div class="flex items-center gap-4">
            <button onclick="goBack()" id="backBtn"
                class="hidden p-2 -ml-2 rounded-full hover:bg-white/10 transition-colors text-slate-200">
                <i data-lucide="arrow-left" class="w-5 h-5 md:w-6 md:h-6"></i>
            </button>
            <div class="flex flex-col">
                <span id="pageTitle"
                    class="text-[10px] md:text-xs font-bold uppercase tracking-[0.2em] text-brand-500">Dashboard</span>
                <h1 class="text-sm md:text-lg font-bold text-white hidden md:block">Medical Insurance Portal</h1>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="hidden md:flex flex-col items-end mr-2">
                <span id="header-username" class="text-xs font-bold text-white">Guest</span>
                <span class="text-[10px] text-brand-300">Verified Member</span>
            </div>
            <button onclick="clearChatSession()"
                class="hidden md:flex items-center gap-2 p-2 px-3 rounded-full bg-slate-800 text-slate-300 hover:text-white hover:bg-slate-700 transition-all border border-slate-700/50 mr-2 text-xs font-bold uppercase tracking-wider title='Restart Chat'">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Clear
            </button>
            <div
                class="w-10 h-10 rounded-full border-2 border-brand-500 p-[2px] shadow-lg shadow-brand-500/20 cursor-pointer hover:scale-105 transition-transform bg-slate-900/50">
                <div id="header-initials"
                    class="w-full h-full rounded-full bg-transparent flex items-center justify-center text-brand-400 text-xs font-bold">
                    G</div>
            </div>
            <button onclick="logout()"
                class="ml-2 p-2 rounded-full bg-white/10 text-white hover:bg-red-500 hover:text-white transition-all border border-white/10"
                title="Logout">
                <i data-lucide="log-out" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 w-full max-w-[1920px] mx-auto pt-20 relative overflow-y-auto no-scrollbar">

        <section id="view-login" class="min-h-[calc(100vh-80px)] flex flex-col items-center justify-center p-6 fade-in">
            <div
                class="w-full max-w-md bg-white/95 backdrop-blur-sm p-8 md:p-12 rounded-[32px] shadow-2xl border border-white/20">
                <div class="text-center mb-10">
                    <div
                        class="w-20 h-20 bg-gradient-to-br from-brand-500 to-brand-600 rounded-3xl mx-auto flex items-center justify-center mb-6 shadow-glow transform rotate-3 hover:rotate-6 transition-transform duration-500">
                        <i data-lucide="shield-check" class="w-10 h-10 text-white fill-white/20"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-900 tracking-tight">Welcome Back</h2>
                    <p class="text-xs uppercase tracking-widest text-slate-400 mt-3 font-semibold">Secure Access Portal
                    </p>
                </div>

                <div id="login-step-1" class="space-y-5">
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold uppercase tracking-wider text-slate-500 ml-1">Email
                            Address</label>
                        <div class="relative group">
                            <i data-lucide="mail"
                                class="absolute left-4 top-4 w-5 h-5 text-slate-400 group-focus-within:text-brand-500 transition-colors"></i>
                            <input type="email" id="emailInput"
                                class="w-full pl-12 pr-4 py-3.5 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-medium focus:outline-none focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 transition-all text-slate-800"
                                placeholder="name@company.com">
                        </div>
                    </div>
                    <button onclick="sendOTP()"
                        class="w-full btn-gold font-semibold py-4 rounded-2xl text-sm transition-all shadow-lg">
                        Continue Securely
                    </button>
                </div>

                <div id="login-step-2" class="hidden space-y-8">
                    <div
                        class="bg-emerald-50 text-emerald-700 px-4 py-3 rounded-2xl text-xs font-medium text-center border border-emerald-100 flex items-center justify-center gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4"></i> OTP sent to your email
                    </div>

                    <div class="space-y-3 text-center">
                        <label class="text-[10px] font-bold uppercase tracking-wider text-slate-400">Enter Access
                            Code</label>
                        <input type="text" id="otpInput" maxlength="4"
                            class="w-full text-center tracking-[1em] py-4 bg-transparent border-b-2 border-slate-200 text-3xl font-bold text-slate-800 focus:outline-none focus:border-brand-500 transition-colors placeholder:text-slate-200 placeholder:tracking-normal"
                            placeholder="โขโขโขโข">
                        <p class="text-xs text-slate-400 mt-2">Use code: <span
                                class="font-mono text-slate-600 font-bold bg-slate-100 px-2 py-0.5 rounded">1234</span>
                        </p>
                    </div>

                    <button onclick="verifyOTP()"
                        class="w-full btn-gold font-semibold py-4 rounded-2xl text-sm transition-all shadow-lg">
                        Verify & Login
                    </button>
                    <button onclick="resetLogin()"
                        class="w-full text-slate-400 hover:text-slate-600 text-xs font-medium py-2 uppercase tracking-wide">Change
                        Email</button>
                </div>
            </div>
        </section>

        <section id="view-landing" class="hidden w-full max-w-7xl mx-auto p-6 md:p-10 lg:p-14 pb-32">
            <div class="mb-12 mt-4 fade-in">
                <h2 class="text-3xl md:text-4xl font-bold text-white tracking-tight">Overview</h2>
                <p class="text-xs font-semibold text-brand-400 uppercase tracking-widest mt-2">Manage your health &
                    insurance</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 fade-in-delayed">
                <div onclick="startInsuranceFlow()"
                    class="lg:col-span-2 group relative bg-white p-8 md:p-10 rounded-[32px] shadow-soft hover:shadow-2xl hover:shadow-brand-500/20 transition-all duration-300 cursor-pointer overflow-hidden border border-white/20">
                    <div
                        class="absolute top-0 right-0 w-64 h-64 bg-brand-50 rounded-full -mr-20 -mt-20 transition-transform group-hover:scale-110">
                    </div>
                    <div
                        class="relative z-10 flex flex-col md:flex-row md:items-center justify-between h-full min-h-[160px]">
                        <div class="mb-6 md:mb-0">
                            <div
                                class="w-14 h-14 bg-brand-500 rounded-2xl flex items-center justify-center shadow-lg shadow-brand-200 text-white mb-6 group-hover:-translate-y-1 transition-transform">
                                <i data-lucide="plus" class="w-7 h-7"></i>
                            </div>
                            <h3 class="font-bold text-2xl text-slate-900 leading-tight">Get Medical Insurance</h3>
                            <p class="text-sm font-medium text-slate-400 mt-2 max-w-sm">Apply for a new policy in
                                minutes using AI assistance.</p>
                        </div>
                        <div
                            class="flex items-center gap-2 btn-gold font-bold text-sm px-6 py-3 rounded-full transition-colors">
                            Start Application <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </div>
                    </div>
                </div>

                <div onclick="showDetails()"
                    class="bg-white p-8 rounded-[32px] shadow-soft border border-white/20 hover:border-brand-300 transition-all cursor-pointer hover:-translate-y-1">
                    <div
                        class="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center text-emerald-600 mb-6">
                        <i data-lucide="file-text" class="w-6 h-6"></i>
                    </div>
                    <h3 class="font-bold text-lg text-slate-800">My Portfolio</h3>
                    <p class="text-xs text-slate-400 mt-2 font-medium uppercase tracking-wide">View active policies</p>
                </div>

                <div onclick="openAskAI()"
                    class="bg-white p-8 rounded-[32px] shadow-soft border border-white/20 hover:border-brand-300 transition-all cursor-pointer hover:-translate-y-1">
                    <div
                        class="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center text-indigo-600 mb-6">
                        <i data-lucide="sparkles" class="w-6 h-6"></i>
                    </div>
                    <h3 class="font-bold text-lg text-slate-800">Ask AI</h3>
                    <p class="text-xs text-slate-400 mt-2 font-medium uppercase tracking-wide">24/7 Support Assistant
                    </p>
                </div>
            </div>

            <div class="mt-12 fade-in-delayed">
                <div
                    class="bg-amber-500/10 border border-amber-500/20 backdrop-blur-md rounded-2xl p-6 flex gap-4 items-center max-w-3xl">
                    <div class="bg-amber-500/20 p-2 rounded-full">
                        <i data-lucide="info" class="w-5 h-5 text-amber-400"></i>
                    </div>
                    <p class="text-sm text-amber-100 font-medium">
                        <strong>Policy Rule:</strong> Only one medical insurance policy can be active per Emirates ID at
                        any given time.
                    </p>
                </div>
            </div>
        </section>

        <section id="view-chat-interface" class="hidden flex flex-col bg-transparent relative"
            style="height: calc(100vh - 80px);">
            <div id="chat-stream"
                class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 max-w-4xl mx-auto w-full scroll-smooth no-scrollbar">
            </div>

            <div class="pt-6 pb-6 px-4 md:px-6 input-container-glass">
                <div class="max-w-3xl mx-auto w-full">
                    <div id="chat-options-container"
                        class="hidden mb-4 flex flex-wrap gap-2 justify-center md:justify-start">
                    </div>

                    <div
                        class="flex items-center gap-3 bg-white p-2 rounded-full border border-slate-200 focus-within:border-brand-500 focus-within:ring-4 focus-within:ring-brand-500/20 transition-all shadow-lg">
                        <button
                            class="p-3 rounded-full text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors">
                            <i data-lucide="mic" class="w-5 h-5"></i>
                        </button>
                        <input type="text" id="chatInput" placeholder="Type your response..."
                            class="flex-1 bg-transparent text-sm md:text-base text-slate-800 placeholder:text-slate-400 focus:outline-none px-2">
                        <button onclick="handleManualSend()"
                            class="p-3 btn-gold rounded-full shadow-lg shadow-brand-500/40 active:scale-95 transition-transform">
                            <i data-lucide="arrow-up" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW ASK AI CHAT -->
        <section id="view-ai-chat" class="hidden flex flex-col bg-transparent relative"
            style="height: calc(100vh - 80px);">
            <div id="ai-chat-stream"
                class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 max-w-4xl mx-auto w-full scroll-smooth no-scrollbar">
            </div>

            <div class="pt-6 pb-6 px-4 md:px-6 input-container-glass">
                <div class="max-w-3xl mx-auto w-full">
                    <div
                        class="flex items-center gap-3 bg-white p-2 rounded-full border border-slate-200 focus-within:border-brand-500 focus-within:ring-4 focus-within:ring-brand-500/10 transition-all shadow-lg">
                        <input type="text" id="aiChatInput"
                            class="flex-1 bg-transparent text-sm md:text-base text-slate-800 placeholder:text-slate-400 focus:outline-none px-6">
                        <button onclick="handleAiManualSend()"
                            class="p-3 btn-gold rounded-full shadow-lg shadow-brand-500/40 active:scale-95 transition-transform">
                            <i data-lucide="arrow-up" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-review"
            class="hidden fixed inset-0 z-50 bg-secondary-dark/80 backdrop-blur-md flex items-center justify-center p-4 overflow-hidden">
            <div
                class="bg-white w-full max-w-2xl max-h-[90vh] rounded-[32px] shadow-2xl relative overflow-hidden animate-slide-up flex flex-col border border-white/20">
                <div class="p-6 md:p-8 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div>
                        <h3 id="review-modal-subtitle"
                            class="text-xs font-bold uppercase tracking-widest text-slate-500">Verification</h3>
                        <h2 id="review-modal-title" class="text-xl font-bold text-slate-900">Review Details</h2>
                    </div>
                    <span id="review-modal-badge"
                        class="px-3 py-1 bg-green-100 text-green-700 text-[10px] font-bold rounded-full uppercase tracking-wide border border-green-200">
                        Extracted from ID
                    </span>
                </div>

                <div class="p-6 md:p-8 space-y-6 flex-1 overflow-y-auto" id="review-form">
                </div>

                <div
                    class="p-6 md:p-8 border-t border-slate-100 bg-slate-50 flex flex-col md:flex-row gap-4 items-center">
                    <div id="review-modal-notice"
                        class="flex-1 text-xs text-orange-600 font-medium flex gap-2 items-center bg-orange-50 p-3 rounded-xl border border-orange-100 w-full md:w-auto">
                        <i data-lucide="alert-triangle" class="w-4 h-4 flex-none"></i>
                        Verify details match Emirates ID to avoid rejection.
                    </div>
                    <button id="review-modal-confirm" onclick="confirmReview()"
                        class="w-full md:w-auto px-8 py-4 btn-gold rounded-xl font-bold text-sm shadow-xl">
                        Confirm & Return to Chat
                    </button>
                </div>
            </div>
        </section>

        <!-- VIEW POLICY DETAILS MODAL -->
        <section id="view-policy-details"
            class="hidden fixed inset-0 z-50 bg-secondary-dark/80 backdrop-blur-md flex items-center justify-center p-4 overflow-hidden">
            <div
                class="bg-white w-full max-w-2xl max-h-[90vh] rounded-[32px] shadow-2xl relative overflow-hidden animate-slide-up flex flex-col border border-white/20">
                <div class="p-6 md:p-8 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                    <div>
                        <h3 class="text-xs font-bold uppercase tracking-widest text-slate-500"
                            id="policy-detail-subtitle">Policy Information</h3>
                        <h2 class="text-xl font-bold text-slate-900" id="policy-detail-title">User Details</h2>
                    </div>
                    <button onclick="closePolicyDetails()"
                        class="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors">
                        <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
                    </button>
                </div>

                <div class="p-6 md:p-8 space-y-6 flex-1 overflow-y-auto" id="policy-detail-container">
                    <!-- Read-only fields injected here -->
                </div>

                <div class="p-6 md:p-8 border-t border-slate-100 bg-slate-50 flex justify-end">
                    <button onclick="closePolicyDetails()"
                        class="w-full md:w-auto px-8 py-4 bg-slate-200 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-300 transition-all">
                        Close
                    </button>
                </div>
            </div>
        </section>

        <section id="view-details" class="hidden w-full max-w-5xl mx-auto p-6 md:p-10">
            <div class="flex items-center justify-between mb-8 mt-4">
                <h2 class="text-xs font-bold text-brand-300 uppercase tracking-widest">Active Policies</h2>
            </div>

            <div id="policies-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            </div>

            <div id="no-policies" class="hidden min-h-[50vh] flex flex-col items-center justify-center text-center">
                <div
                    class="w-20 h-20 bg-white/10 backdrop-blur rounded-[2rem] flex items-center justify-center mb-6 rotate-12 border border-white/10">
                    <i data-lucide="file-minus" class="w-10 h-10 text-slate-400"></i>
                </div>
                <h3 class="text-lg font-bold text-white">No active insurance</h3>
                <p class="text-sm text-slate-400 mt-2 max-w-xs mx-auto">You haven't purchased any medical insurance
                    policies yet.</p>
                <button onclick="startInsuranceFlow()"
                    class="mt-8 px-8 py-4 btn-gold text-white rounded-xl text-xs font-bold uppercase tracking-widest shadow-lg">Get
                    Started</button>
            </div>
        </section>

    </main>

    <!-- GUIDELINES MODAL -->
    <div id="modal-guidelines"
        class="hidden fixed inset-0 z-[60] bg-secondary-dark/90 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[32px] p-8 shadow-2xl relative overflow-hidden animate-slide-up">
            <div class="absolute top-0 left-0 w-full h-2 bg-brand-500"></div>
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-xs font-bold uppercase tracking-widest text-slate-900">Before We Start</h3>
                <button onclick="closeGuidelines()"
                    class="p-2 bg-slate-50 rounded-full hover:bg-slate-100 transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
                </button>
            </div>

            <div
                class="bg-blue-50 border border-blue-100 text-blue-900 text-sm p-6 rounded-2xl mb-6 leading-relaxed font-medium shadow-sm">
                "Please complete the medical insurance process once you start it. Leaving midway will cancel the
                application."
            </div>

            <div
                class="flex items-center gap-4 text-xs font-semibold text-slate-500 mb-10 bg-slate-50 p-4 rounded-xl border border-slate-100">
                <div class="p-2 bg-white rounded-lg shadow-sm">
                    <i data-lucide="credit-card" class="w-5 h-5 text-slate-400"></i>
                </div>
                Please have your Emirates ID ready for scanning.
            </div>

            <button onclick="closeGuidelines()"
                class="w-full btn-gold text-white py-4 rounded-2xl text-sm font-bold shadow-lg">
                I Understand, Let's Go
            </button>
        </div>
    </div>

    <!-- CUSTOM ALERT MODAL -->
    <div id="modal-alert"
        class="hidden fixed inset-0 z-[100] bg-secondary-dark/90 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[32px] p-8 shadow-2xl relative overflow-hidden animate-slide-up">
            <div id="alert-accent" class="absolute top-0 left-0 w-full h-2 bg-brand-500"></div>

            <div class="flex flex-col items-center text-center">
                <div id="alert-icon-container"
                    class="w-16 h-16 rounded-2xl flex items-center justify-center mb-6 shadow-soft">
                    <i id="alert-icon" data-lucide="info" class="w-8 h-8"></i>
                </div>

                <h3 id="alert-title" class="text-xl font-bold text-slate-900 mb-2">Notification</h3>
                <p id="alert-message" class="text-sm text-slate-500 leading-relaxed font-medium mb-8">This is a custom
                    message.</p>

                <div class="flex gap-3 w-full" id="alert-buttons">
                    <button id="alert-btn-cancel"
                        class="hidden flex-1 px-6 py-3.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-2xl text-xs font-bold uppercase tracking-wider transition-all">
                        Cancel
                    </button>
                    <button id="alert-btn-confirm"
                        class="flex-1 px-6 py-3.5 btn-gold text-white rounded-2xl text-xs font-bold uppercase tracking-wider shadow-lg">
                        Okay
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ICONS ---
        lucide.createIcons();

        // --- API CONFIG ---
        const API_BASE = 'http://127.0.0.1:8000/api';

        // --- TRANSLATIONS ---
        const translations = {
            en: {
                welcome: "Hi! Welcome to the Insurance Assistant ๐",
                select_lang: "Please choose the language youโre most comfortable with.",
                looking_for_insurance: "Are you looking to get Medical Insurance today?",
                yes_start: "Yes, letโs start",
                no_cancel: "No, maybe later",
                cancel_msg: "No worries! Just let us know whenever you need help ๐",
                employee_or_dependent: "To get started, please tell us โ are you an Employee or a Dependent?",
                employee: "Employee",
                dependent: "Dependent",
                income_self: "What is your monthly income?",
                income_sponsor: "What is your sponsorโs monthly income?",
                dependent_type_q: "Please select the type of dependent you are.",
                spouse: "Spouse",
                child: "Child",
                upload_self: "Please upload your valid Emirates ID to continue.",
                upload_sponsor: "Please upload your Sponsorโs Emirates ID to continue.",
                btn_upload: "Scan or Upload Emirates ID",
                uploading: "Uploading your IDโฆ please wait.",
                review_details: "Please review your details carefully before proceeding.",
                verified_details: "Verified Details",
                name: "Full Name",
                eid: "Emirates ID",
                dob: "Date of Birth",
                nationality: "Nationality",
                gender: "Gender",
                issuing_date: "Issuing Date",
                expiry_date: "Expiry Date",
                issuing_place: "Issuing Place",
                occupation: "Occupation",
                sponsor: "Sponsor",
                mobile: "Mobile Number",
                salary_range_label: "Salary Range",
                found_plans: (n) => `Good news! I found ${n} eligible plan(s) for you. Please choose one to continue.`,
                no_plans: "Sorry! Based on your salary range and issuing place, there are no eligible online plans available right now.",
                eligible: "Eligible",
                select_plan_msg: (name, type) => `Iโd like to proceed with the ${name} (${type}) plan.`,
                success_title: "Success ๐",
                policy_active: "Your policy is now active",
                policy_no: "Policy Number",
                premium: "Premium Amount",
                continue_btn: "Continue",
                welcome_back: "Welcome back! Iโve restored your previous session for you.",
                continue_income: "Letโs continue from where you left off. Please select your income range.",
                restart_prompt: "Please use the options above to continue your application.",
                below_4000: "Below 4000 AED",
                between_4000_5000: "4000 โ 5000 AED",
                above_5000: "Above 5000 AED",
                reset_failed: "Oops! We couldnโt reset the session. Please try again.",
                start_fresh_q: "Start fresh?",
                start_fresh_msg: "This will clear your current progress and restart the application.",
                upload_failed: "We couldnโt process the document. Please try again.",
                upload_error: "Something went wrong while uploading the document.",
                return_dashboard: "Return to Dashboard",
                verifying: "Verifying your detailsโฆ",
                sending: "Sendingโฆ",
                connection_error_title: "Connection Issue",
                connection_error_msg: "Please check your internet connection and try again.",
                logout_q: "Log out",
                logout_msg: "Are you sure you want to log out?",
                exit_session_q: "Exit session?",
                exit_session_msg: "If you exit now, your progress may be lost.",
                login_failed_title: "Login Failed",
                req_missing: "Some required information is missing",
                enter_otp: "Please enter the verification code sent to you",
                expired_doc_title: "Document Expired",
                expired_doc_msg: "Your Emirates ID has expired. We canโt continue with the process.",
                missing_info: "Missing Information",
                enter_mobile: "Please enter a valid mobile number.",
                review_details_title: "Review Your Details",
                eid_no: "Emirates ID Number",
                verification_title: "Verification",
                extracted_label: "Extracted from Emirates ID",
                verify_notice: "Please make sure the details match your Emirates ID to avoid rejection.",
                confirm_btn: "Confirm and Continue",
                male: "Male",
                female: "Female",
                mobile_number_label: "Mobile Number",
                policy_info_label: "Policy Details",
                user_details_label: "Your Details",
                close_btn: "Close",
                ai_placeholder: "Ask anything about insurance...",
                ai_welcome_msg: "Hello! I'm your insurance assistant. Ask me about coverage, company details, or support.",
                ai_thinking: "Gia is thinking..."
            },
            ml: {
                welcome: "เดเตปเดทเตเดฑเตปเดธเต เดเดธเดฟเดธเตเดฑเตเดฑเดจเตเดฑเดฟเดฒเตเดเตเดเต เดธเตเดตเดพเดเดคเด ๐",
                select_lang: "เดจเดฟเดเตเดเตพเดเตเดเต เดเดณเตเดชเตเดชเดฎเตเดณเตเดณ เดญเดพเดท เดคเดฟเดฐเดเตเดเตเดเตเดเตเดเต.",
                looking_for_insurance: "เดจเดฟเดเตเดเตพ เดฎเตเดกเดฟเดเตเดเตฝ เดเตปเดทเตเดฑเตปเดธเต เดเดเตเดเตเดเดพเตป เดเดเตเดฐเดนเดฟเดเตเดเตเดจเตเดจเตเดฃเตเดเต?",
                yes_start: "เดเดคเต, เดคเตเดเดเตเดเดพเด",
                no_cancel: "เดตเตเดฃเตเด, เดชเดฟเดจเตเดจเตเดเต",
                cancel_msg: "เดถเดฐเดฟ ๐ เดจเดฟเดเตเดเตพเดเตเดเต เดเดตเดถเตเดฏเดฎเตเดฃเตเดเดพเดเตเดฎเตเดชเตเตพ เดเดเตเดเดณเต เดเดฑเดฟเดฏเดฟเดเตเดเต.",
                employee_or_dependent: "เดเดฐเดเดญเดฟเดเตเดเดพเตป, เดฆเดฏเดตเดพเดฏเดฟ เดชเดฑเดฏเต โ เดจเดฟเดเตเดเตพ Employee เดเดฃเต Dependent เดเดฃเต?",
                employee: "Employee (เดเตเดฒเดฟเดเตเดเดพเดฐเตป)",
                dependent: "Dependent (เดเดถเตเดฐเดฟเดคเตป)",
                income_self: "เดจเดฟเดเตเดเดณเตเดเต เดชเตเดฐเดคเดฟเดฎเดพเดธ เดตเดฐเตเดฎเดพเดจเด เดเดคเตเดฐเดฏเดพเดฃเต?",
                income_sponsor: "เดจเดฟเดเตเดเดณเตเดเต เดธเตเดชเตเตบเดธเดฑเตเดเต เดชเตเดฐเดคเดฟเดฎเดพเดธ เดตเดฐเตเดฎเดพเดจเด เดเดคเตเดฐเดฏเดพเดฃเต?",
                dependent_type_q: "เดจเดฟเดเตเดเตพ เดเดคเต เดคเดฐเดคเตเดคเดฟเดฒเตเดณเตเดณ เดเดถเตเดฐเดฟเดคเดจเดพเดฃเต?",
                spouse: "เดญเดพเดฐเตเดฏ / เดญเตผเดคเตเดคเดพเดตเต",
                child: "เดเตเดเตเดเดฟ",
                upload_self: "เดคเตเดเดฐเดพเตป, เดฆเดฏเดตเดพเดฏเดฟ เดจเดฟเดเตเดเดณเตเดเต Emirates ID เดเดชเตโเดฒเตเดกเต เดเตเดฏเตเดฏเต.",
                upload_sponsor: "เดคเตเดเดฐเดพเตป, เดฆเดฏเดตเดพเดฏเดฟ เดธเตเดชเตเตบเดธเดฑเตเดเต Emirates ID เดเดชเตโเดฒเตเดกเต เดเตเดฏเตเดฏเต.",
                btn_upload: "เดธเตเดเดพเตป เดเตเดฏเตเดฏเตเด / ID เดเดชเตโเดฒเตเดกเต เดเตเดฏเตเดฏเตเด",
                uploading: "ID เดเดชเตโเดฒเตเดกเต เดเตเดฏเตเดฏเตเดจเตเดจเตโฆ เดฆเดฏเดตเดพเดฏเดฟ เดเดพเดคเตเดคเดฟเดฐเดฟเดเตเดเตเด.",
                review_details: "เดคเตเดเดฐเตเดจเตเดจเดคเดฟเดจเต เดฎเตเดฎเตเดชเต เดจเดฟเดเตเดเดณเตเดเต เดตเดฟเดตเดฐเดเตเดเตพ เดชเดฐเดฟเดถเตเดงเดฟเดเตเดเต.",
                verified_details: "เดธเตเดฅเดฟเดฐเตเดเดฐเดฟเดเตเด เดตเดฟเดตเดฐเดเตเดเตพ",
                name: "เดฎเตเดดเตเดตเตป เดชเตเดฐเต",
                eid: "Emirates ID",
                dob: "เดเดจเดจ เดคเตเดฏเดคเดฟ",
                nationality: "เดฆเตเดถเตเดฏเดค",
                gender: "เดฒเดฟเดเดเด",
                issuing_date: "เดเดทเตเดฏเต เดเตเดฏเตเดค เดคเตเดฏเดคเดฟ",
                expiry_date: "เดเดพเดฒเดนเดฐเดฃเดชเตเดชเตเดเตเดจเตเดจ เดคเตเดฏเดคเดฟ",
                issuing_place: "เดเดทเตเดฏเต เดเตเดฏเตเดค เดธเตเดฅเดฒเด",
                occupation: "เดคเตเดดเดฟเตฝ",
                sponsor: "เดธเตเดชเตเตบเดธเตผ",
                mobile: "เดฎเตเดฌเตเตฝ เดจเดฎเตเดชเตผ",
                salary_range_label: "เดตเดฐเตเดฎเดพเดจ เดชเดฐเดฟเดงเดฟ",
                found_plans: (n) => `เดธเดจเตเดคเตเดทเดตเดพเตผเดคเตเดค! เดจเดฟเดเตเดเตพเดเตเดเต เดเดจเตเดฏเตเดเตเดฏเดฎเดพเดฏ ${n} เดชเตเดฒเดพเตป(เดเตพ) เดเดฃเตเดเตเดคเตเดคเดฟเดฏเดฟเดเตเดเตเดฃเตเดเต. เดเดจเตเดจเต เดคเดฟเดฐเดเตเดเตเดเตเดเตเดเต.`,
                no_plans: "เดเตเดทเดฎเดฟเดเตเดเดฃเด. เดจเดฟเดเตเดเดณเตเดเต เดตเดฐเตเดฎเดพเดจเดตเตเด เดเดทเตเดฏเต เดเตเดฏเตเดค เดธเตเดฅเดฒเดตเตเด เดเดเดฟเดธเตเดฅเดพเดจเดฎเดพเดเตเดเดฟ เดเดชเตเดชเตเตพ เดชเตเดฒเดพเดจเตเดเตพ เดฒเดญเตเดฏเดฎเดฒเตเดฒ.",
                eligible: "เดฏเตเดเตเดฏเดฎเดพเดฃเต",
                select_plan_msg: (name, type) => `เดเดพเตป ${name} (${type}) เดชเตเดฒเดพเตป เดเดเตเดเตเดเดพเด.`,
                success_title: "เดตเดฟเดเดฏเด ๐",
                policy_active: "เดจเดฟเดเตเดเดณเตเดเต เดชเตเดณเดฟเดธเดฟ เดธเดเตเดตเดฎเดพเดฏเดฟ",
                policy_no: "เดชเตเดณเดฟเดธเดฟ เดจเดฎเตเดชเตผ",
                premium: "เดชเตเดฐเตเดฎเดฟเดฏเด",
                continue_btn: "เดคเตเดเดฐเตเด",
                welcome_back: "เดตเตเดฃเตเดเตเด เดธเตเดตเดพเดเดคเด! เดจเดฟเดเตเดเดณเตเดเต เดฎเตเตป เดธเตเดทเตป เดชเตเดจเดเดธเตเดฅเดพเดชเดฟเดเตเดเดฟเดเตเดเตเดฃเตเดเต.",
                continue_income: "เดจเดฎเตเดเตเดเต เดคเตเดเดฐเดพเด. เดฆเดฏเดตเดพเดฏเดฟ เดตเดฐเตเดฎเดพเดจ เดชเดฐเดฟเดงเดฟ เดคเดฟเดฐเดเตเดเตเดเตเดเตเดเต.",
                restart_prompt: "เดฎเตเดเดณเดฟเตฝ เดจเตฝเดเดฟเดฏเดฟเดฐเดฟเดเตเดเตเดจเตเดจ เดเดชเตเดทเดจเตเดเตพ เดเดชเดฏเตเดเดฟเดเตเดเต เดคเตเดเดฐเต.",
                below_4000: "4000 AED-เตฝ เดคเดพเดดเต",
                between_4000_5000: "4000 โ 5000 AED",
                above_5000: "5000 AED-เดเตเดเต เดฎเตเดเดณเดฟเตฝ",
                reset_failed: "เดธเตเดทเตป เดฑเตเดธเตเดฑเตเดฑเต เดเตเดฏเตเดฏเดพเตป เดเดดเดฟเดเตเดเดฟเดฒเตเดฒ. เดตเตเดฃเตเดเตเด เดถเตเดฐเดฎเดฟเดเตเดเต.",
                start_fresh_q: "เดชเตเดคเตเดคเดพเดฏเดฟ เดคเตเดเดเตเดเดฃเต?",
                start_fresh_msg: "เดเดคเต เดจเดฟเดฒเดตเดฟเดฒเต เดชเตเดฐเตเดเดคเดฟ เดฎเดพเดฏเตเดเตเดเต เดตเตเดฃเตเดเตเด เดคเตเดเดเตเดเตเด.",
                upload_failed: "เดฐเตเด เดชเตเดฐเตเดธเดธเต เดเตเดฏเตเดฏเดพเตป เดเดดเดฟเดเตเดเดฟเดฒเตเดฒ. เดตเตเดฃเตเดเตเด เดถเตเดฐเดฎเดฟเดเตเดเต.",
                upload_error: "เดฐเตเด เดเดชเตโเดฒเตเดกเต เดเตเดฏเตเดฏเตเดฎเตเดชเตเตพ เดชเดฟเดถเดเต เดธเดเดญเดตเดฟเดเตเดเต.",
                return_dashboard: "เดกเดพเดทเตโเดฌเตเตผเดกเดฟเดฒเตเดเตเดเต เดฎเดเดเตเดเตเด",
                verifying: "เดตเดฟเดตเดฐเดเตเดเตพ เดชเดฐเดฟเดถเตเดงเดฟเดเตเดเตเดจเตเดจเตโฆ",
                sending: "เดเดฏเดเตเดเตเดจเตเดจเตโฆ",
                connection_error_title: "เดเดฃเดเตเดทเตป เดชเตเดฐเดถเตเดจเด",
                connection_error_msg: "เดเดจเตเดฑเตผเดจเตเดฑเตเดฑเต เดเดฃเดเตเดทเตป เดชเดฐเดฟเดถเตเดงเดฟเดเตเดเต เดตเตเดฃเตเดเตเด เดถเตเดฐเดฎเดฟเดเตเดเต.",
                logout_q: "เดฒเตเดเต เดเดเตเดเต เดเตเดฏเตเดฏเดฃเต?",
                logout_msg: "เดจเดฟเดเตเดเตพเดเตเดเต เดฒเตเดเต เดเดเตเดเต เดเตเดฏเตเดฏเดฃเดฎเตเดจเตเดจเต เดเดฑเดชเตเดชเดพเดฃเต?",
                exit_session_q: "เดธเตเดทเตป เดเดตเดธเดพเดจเดฟเดชเตเดชเดฟเดเตเดเดฃเต?",
                exit_session_msg: "เดเดชเตเดชเตเตพ เดชเตเดฑเดคเตเดคเตเดชเตเดฏเดพเตฝ เดชเตเดฐเตเดเดคเดฟ เดจเดทเตเดเดชเตเดชเตเดเดพเด.",
                login_failed_title: "เดฒเตเดเดฟเตป เดชเดฐเดพเดเดฏเดชเตเดชเตเดเตเดเต",
                req_missing: "เดเดตเดถเตเดฏเดฎเดพเดฏ เดตเดฟเดตเดฐเดเตเดเตพ เดฒเดญเตเดฏเดฎเดฒเตเดฒ",
                enter_otp: "เดจเดฟเดเตเดเตพเดเตเดเต เดฒเดญเดฟเดเตเด เดตเตเดฐเดฟเดซเดฟเดเตเดเตเดทเตป เดเตเดกเต เดจเตฝเดเต",
                expired_doc_title: "เดฐเตเดเดฏเตเดเต เดเดพเดฒเดพเดตเดงเดฟ เดเดดเดฟเดเตเดเต",
                expired_doc_msg: "Emirates ID เดเดพเดฒเดนเดฐเดฃเดชเตเดชเตเดเตเดเต. เดชเตเดฐเดเตเดฐเดฟเดฏ เดคเตเดเดฐเดพเตป เดเดดเดฟเดฏเดฟเดฒเตเดฒ.",
                missing_info: "เดตเดฟเดตเดฐเดเตเดเตพ เดเดชเตเตผเดฃเตเดฃเดฎเดพเดฃเต",
                enter_mobile: "เดฆเดฏเดตเดพเดฏเดฟ เดธเดพเดงเตเดตเดพเดฏ เดฎเตเดฌเตเตฝ เดจเดฎเตเดชเตผ เดจเตฝเดเต.",
                review_details_title: "เดตเดฟเดตเดฐเดเตเดเตพ เดชเดฐเดฟเดถเตเดงเดฟเดเตเดเตเด",
                eid_no: "Emirates ID เดจเดฎเตเดชเตผ",
                verification_title: "เดธเตเดฅเดฟเดฐเตเดเดฐเดฃเด",
                extracted_label: "ID-เดฏเดฟเตฝ เดจเดฟเดจเตเดจเต เดเดเตเดคเตเดค เดตเดฟเดตเดฐเดเตเดเตพ",
                verify_notice: "เดฑเดฟเดเดเตเดทเตป เดเดดเดฟเดตเดพเดเตเดเดพเตป เดตเดฟเดตเดฐเดเตเดเตพ ID-เดฏเตเดฎเดพเดฏเดฟ เดชเตเดฐเตเดคเตเดคเดชเตเดชเตเดเตเดจเตเดจเตเดตเตเดจเตเดจเต เดเดฑเดชเตเดชเดพเดเตเดเต.",
                confirm_btn: "เดธเตเดฅเดฟเดฐเตเดเดฐเดฟเดเตเดเต เดคเตเดเดฐเตเด",
                male: "เดชเตเดฐเตเดทเตป",
                female: "เดธเตเดคเตเดฐเต",
                mobile_number_label: "เดฎเตเดฌเตเตฝ เดจเดฎเตเดชเตผ",
                policy_info_label: "เดชเตเดณเดฟเดธเดฟ เดตเดฟเดตเดฐเดเตเดเตพ",
                user_details_label: "เดจเดฟเดเตเดเดณเตเดเต เดตเดฟเดตเดฐเดเตเดเตพ",
                close_btn: "เดเดเดฏเตเดเตเดเตเด",
                ai_placeholder: "เดเตปเดทเตเดฑเตปเดธเดฟเดจเตเดเตเดเตเดฑเดฟเดเตเดเต เดเดจเตเดคเตเด เดเตเดฆเดฟเดเตเดเต...",
                ai_welcome_msg: "เดนเดฒเต! เดเดพเตป เดจเดฟเดเตเดเดณเตเดเต เดเตปเดทเตเดฑเตปเดธเต เดเดธเดฟเดธเตเดฑเตเดฑเดจเตเดฑเดพเดฃเต. เดเดตเดฑเตเดเต, เดเดฎเตเดชเดจเดฟ เดตเดฟเดตเดฐเดเตเดเตพ เดเดฒเตเดฒเตเดเตเดเดฟเตฝ เดธเดชเตเดชเตเตผเดเตเดเต เดเดจเตเดจเดฟเดตเดฏเตเดเตเดเตเดฑเดฟเดเตเดเต เดเดจเตเดจเตเดเต เดเตเดฆเดฟเดเตเดเดพเด.",
                ai_thinking: "เดเดฟเดฏ เดเดฟเดจเตเดคเดฟเดเตเดเตเดจเตเดจเต..."
            },
            ar: {
                welcome: "ูุฑุญุจูุง ุจู ๐ ูู ูุณุงุนุฏ ุงูุชุฃููู",
                select_lang: "ูุฑุฌู ุงุฎุชูุงุฑ ุงููุบุฉ ุงูุชู ุชูุถููุง.",
                looking_for_insurance: "ูู ุชุฑุบุจ ูู ุงูุญุตูู ุนูู ุชุฃููู ุทุจู ุงููููุ",
                yes_start: "ูุนูุ ููุจุฏุฃ",
                no_cancel: "ูุงุ ูุงุญููุง",
                cancel_msg: "ูุง ูุดููุฉ ๐ ุฃุฎุจุฑูุง ูุชู ูุง ุงุญุชุฌุช ุฅูู ุงููุณุงุนุฏุฉ.",
                employee_or_dependent: "ููุจุฏุกุ ูู ูุถูู ุฃุฎุจุฑูุง โ ูู ุฃูุช ููุธู ุฃู ุชุงุจุนุ",
                employee: "ููุธู",
                dependent: "ุชุงุจุน",
                income_self: "ูุง ูู ุฏุฎูู ุงูุดูุฑูุ",
                income_sponsor: "ูุง ูู ุงูุฏุฎู ุงูุดูุฑู ููููููุ",
                dependent_type_q: "ูุง ููุน ุงูุชุงุจุน ุงูุฐู ุฃูุช ุนูููุ",
                spouse: "ุฒูุฌ / ุฒูุฌุฉ",
                child: "ุทูู",
                upload_self: "ูููุชุงุจุนุฉุ ูุฑุฌู ุชุญููู ุจุทุงูุฉ ุงููููุฉ ุงูุฅูุงุฑุงุชูุฉ ุงูุฎุงุตุฉ ุจู.",
                upload_sponsor: "ูููุชุงุจุนุฉุ ูุฑุฌู ุชุญููู ุจุทุงูุฉ ุงููููุฉ ุงูุฅูุงุฑุงุชูุฉ ุงูุฎุงุตุฉ ุจุงููููู.",
                btn_upload: "ูุณุญ ุฃู ุชุญููู ุงููููุฉ",
                uploading: "ุฌุงุฑู ุชุญููู ุงููููุฉโฆ ูุฑุฌู ุงูุงูุชุธุงุฑ.",
                review_details: "ูุฑุฌู ูุฑุงุฌุนุฉ ุจูุงูุงุชู ุจุนูุงูุฉ ูุจู ุงููุชุงุจุนุฉ.",
                verified_details: "ุงูุจูุงูุงุช ุงููุคูุฏุฉ",
                name: "ุงูุงุณู ุงููุงูู",
                eid: "ุงููููุฉ ุงูุฅูุงุฑุงุชูุฉ",
                dob: "ุชุงุฑูุฎ ุงููููุงุฏ",
                nationality: "ุงูุฌูุณูุฉ",
                gender: "ุงูุฌูุณ",
                issuing_date: "ุชุงุฑูุฎ ุงูุฅุตุฏุงุฑ",
                expiry_date: "ุชุงุฑูุฎ ุงูุงูุชูุงุก",
                issuing_place: "ููุงู ุงูุฅุตุฏุงุฑ",
                occupation: "ุงููููุฉ",
                sponsor: "ุงููููู",
                mobile: "ุฑูู ุงููุงุชู ุงููุชุญุฑู",
                salary_range_label: "ูุทุงู ุงูุฑุงุชุจ",
                found_plans: (n) => `ุฎุจุฑ ุณุงุฑ! ูุฌุฏูุง ${n} ุฎุทุฉ ูุคููุฉ ูู. ูุฑุฌู ุงุฎุชูุงุฑ ุฅุญุฏุงูุง ูููุชุงุจุนุฉ.`,
                no_plans: "ูุนุชุฐุฑุ ุจูุงุกู ุนูู ุงูุฑุงุชุจ ูููุงู ุงูุฅุตุฏุงุฑุ ูุง ุชูุฌุฏ ุฎุทุท ูุชุงุญุฉ ุญุงูููุง.",
                eligible: "ูุคูู",
                select_plan_msg: (name, type) => `ุฃุฑุบุจ ูู ุงุฎุชูุงุฑ ุฎุทุฉ ${name} (${type}).`,
                success_title: "ุชู ุจูุฌุงุญ ๐",
                policy_active: "ุชู ุชูุนูู ุงูุจูููุตุฉ ุงูุฎุงุตุฉ ุจู",
                policy_no: "ุฑูู ุงูุจูููุตุฉ",
                premium: "ูููุฉ ุงููุณุท",
                continue_btn: "ูุชุงุจุนุฉ",
                welcome_back: "ูุฑุญุจูุง ุจุนูุฏุชู! ููุฏ ูููุง ุจุงุณุชุนุงุฏุฉ ุฌูุณุชู ุงูุณุงุจูุฉ.",
                continue_income: "ูููููู ูู ุญูุซ ุชูููุช. ูุฑุฌู ุงุฎุชูุงุฑ ูุทุงู ุงูุฏุฎู.",
                restart_prompt: "ูุฑุฌู ุงุณุชุฎุฏุงู ุงูุฎูุงุฑุงุช ุฃุนูุงู ููุชุงุจุนุฉ ุงูุทูุจ.",
                below_4000: "ุฃูู ูู 4000 ุฏุฑูู",
                between_4000_5000: "4000 โ 5000 ุฏุฑูู",
                above_5000: "ุฃูุซุฑ ูู 5000 ุฏุฑูู",
                reset_failed: "ูู ูุชููู ูู ุฅุนุงุฏุฉ ุชุนููู ุงูุฌูุณุฉ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.",
                start_fresh_q: "ุงูุจุฏุก ูู ุฌุฏูุฏุ",
                start_fresh_msg: "ุณูุคุฏู ุฐูู ุฅูู ูุณุญ ุงูุชูุฏู ุงูุญุงูู ูุจุฏุก ุงูุทูุจ ูู ุฌุฏูุฏ.",
                upload_failed: "ุชุนุฐุฑ ูุนุงูุฌุฉ ุงููุณุชูุฏ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.",
                upload_error: "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงููุณุชูุฏ.",
                return_dashboard: "ุงูุนูุฏุฉ ุฅูู ููุญุฉ ุงูุชุญูู",
                verifying: "ุฌุงุฑู ุงูุชุญูู ูู ุงูุจูุงูุงุชโฆ",
                sending: "ุฌุงุฑู ุงูุฅุฑุณุงูโฆ",
                connection_error_title: "ูุดููุฉ ูู ุงูุงุชุตุงู",
                connection_error_msg: "ูุฑุฌู ุงูุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.",
                logout_q: "ุชุณุฌูู ุงูุฎุฑูุฌ",
                logout_msg: "ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ุชุณุฌูู ุงูุฎุฑูุฌุ",
                exit_session_q: "ุฅููุงุก ุงูุฌูุณุฉุ",
                exit_session_msg: "ูุฏ ูุชู ููุฏุงู ุงูุชูุฏู ุฅุฐุง ููุช ุจุฅููุงุก ุงูุฌูุณุฉ ุงูุขู.",
                login_failed_title: "ูุดู ุชุณุฌูู ุงูุฏุฎูู",
                req_missing: "ุจุนุถ ุงููุชุทูุจุงุช ููููุฏุฉ",
                enter_otp: "ูุฑุฌู ุฅุฏุฎุงู ุฑูุฒ ุงูุชุญูู ุงููุฑุณู ุฅููู",
                expired_doc_title: "ุงููุณุชูุฏ ููุชูู ุงูุตูุงุญูุฉ",
                expired_doc_msg: "ุงูุชูุช ุตูุงุญูุฉ ุงููููุฉ ุงูุฅูุงุฑุงุชูุฉ. ูุง ูููู ูุชุงุจุนุฉ ุงูุนูููุฉ.",
                missing_info: "ูุนูููุงุช ูุงูุตุฉ",
                enter_mobile: "ูุฑุฌู ุฅุฏุฎุงู ุฑูู ูุงุชู ูุชุญุฑู ุตุญูุญ.",
                review_details_title: "ูุฑุงุฌุนุฉ ุงูุจูุงูุงุช",
                eid_no: "ุฑูู ุงููููุฉ ุงูุฅูุงุฑุงุชูุฉ",
                verification_title: "ุงูุชุญูู",
                extracted_label: "ุชู ุงุณุชุฎุฑุงุฌู ูู ุงููููุฉ",
                verify_notice: "ูุฑุฌู ุงูุชุฃูุฏ ูู ุชุทุงุจู ุงูุจูุงูุงุช ูุน ุงููููุฉ ูุชุฌูุจ ุงูุฑูุถ.",
                confirm_btn: "ุชุฃููุฏ ูุงููุชุงุจุนุฉ",
                male: "ุฐูุฑ",
                female: "ุฃูุซู",
                mobile_number_label: "ุฑูู ุงููุงุชู ุงููุชุญุฑู",
                policy_info_label: "ูุนูููุงุช ุงูุจูููุตุฉ",
                user_details_label: "ุจูุงูุงุช ุงููุณุชุฎุฏู",
                close_btn: "ุฅุบูุงู",
                ai_placeholder: "ุงุณุฃููู ุฃู ุดูุก ุนู ุงูุชุฃููู...",
                ai_welcome_msg: "ุฃููุงู ุจู! ุฃูุง ูุณุงุนุฏ ุงูุชุฃููู ุงูุฎุงุต ุจู. ุงุณุฃููู ุนู ุงูุชุบุทูุฉุ ุฃู ุชูุงุตูู ุงูุดุฑูุฉุ ุฃู ุงูุฏุนู ุงูููู.",
                ai_thinking: "ุฌูุง ุชููุฑ..."
            },
            hi: {
                welcome: "เคเคเคถเฅเคฏเฅเคฐเฅเคเคธ เคเคธเคฟเคธเฅเคเฅเคเค เคฎเฅเค เคเคชเคเคพ เคธเฅเคตเคพเคเคค เคนเฅ ๐",
                select_lang: "เคเฅเคชเคฏเคพ เคเคชเคจเฅ เคชเคธเคเคฆ เคเฅ เคญเคพเคทเคพ เคเฅเคจเฅเคเฅค",
                looking_for_insurance: "เคเฅเคฏเคพ เคเคช เคเค เคฎเฅเคกเคฟเคเคฒ เคเคเคถเฅเคฏเฅเคฐเฅเคเคธ เคฒเฅเคจเคพ เคเคพเคนเคคเฅ เคนเฅเค?",
                yes_start: "เคนเคพเค, เคถเฅเคฐเฅ เคเคฐเฅเค",
                no_cancel: "เคจเคนเฅเค, เคฌเคพเคฆ เคฎเฅเค",
                cancel_msg: "เคเฅเค เคฌเคพเคค เคจเคนเฅเค ๐ เคเคฌ เคเคผเคฐเฅเคฐเคค เคนเฅ, เคนเคฎเฅเค เคฌเคคเคพเคเคเฅค",
                employee_or_dependent: "เคถเฅเคฐเฅ เคเคฐเคจเฅ เคเฅ เคฒเคฟเค เคฌเคคเคพเคเค โ เคเฅเคฏเคพ เคเคช เคเคฐเฅเคฎเคเคพเคฐเฅ เคนเฅเค เคฏเคพ เคเคถเฅเคฐเคฟเคค?",
                employee: "เคเคฐเฅเคฎเคเคพเคฐเฅ (Employee)",
                dependent: "เคเคถเฅเคฐเคฟเคค (Dependent)",
                income_self: "เคเคชเคเฅ เคฎเคพเคธเคฟเค เคเคฏ เคเคฟเคคเคจเฅ เคนเฅ?",
                income_sponsor: "เคเคชเคเฅ เคธเฅเคชเฅเคจเฅเคธเคฐ เคเฅ เคฎเคพเคธเคฟเค เคเคฏ เคเคฟเคคเคจเฅ เคนเฅ?",
                dependent_type_q: "เคเคช เคเคฟเคธ เคชเฅเคฐเคเคพเคฐ เคเฅ เคเคถเฅเคฐเคฟเคค เคนเฅเค?",
                spouse: "เคชเคคเคฟ / เคชเคคเฅเคจเฅ",
                child: "เคฌเคเฅเคเคพ",
                upload_self: "เคเคเฅ เคฌเคขเคผเคจเฅ เคเฅ เคฒเคฟเค เคเฅเคชเคฏเคพ เคเคชเคจเฅ เคตเฅเคง Emirates ID เคเคชเคฒเฅเคก เคเคฐเฅเคเฅค",
                upload_sponsor: "เคเคเฅ เคฌเคขเคผเคจเฅ เคเฅ เคฒเคฟเค เคเฅเคชเคฏเคพ เคเคชเคจเฅ เคธเฅเคชเฅเคจเฅเคธเคฐ เคเฅ Emirates ID เคเคชเคฒเฅเคก เคเคฐเฅเคเฅค",
                btn_upload: "เคธเฅเคเฅเคจ เคเคฐเฅเค / ID เคเคชเคฒเฅเคก เคเคฐเฅเค",
                uploading: "ID เคเคชเคฒเฅเคก เคนเฅ เคฐเคนเฅ เคนเฅโฆ เคเฅเคชเคฏเคพ เคชเฅเคฐเคคเฅเคเฅเคทเคพ เคเคฐเฅเคเฅค",
                review_details: "เคเคเฅ เคฌเคขเคผเคจเฅ เคธเฅ เคชเคนเคฒเฅ เคเคชเคจเฅ เคตเคฟเคตเคฐเคฃ เคเฅ เคเคพเคเค เคเคฐเฅเคเฅค",
                verified_details: "เคธเคคเฅเคฏเคพเคชเคฟเคค เคตเคฟเคตเคฐเคฃ",
                name: "เคชเฅเคฐเคพ เคจเคพเคฎ",
                eid: "Emirates ID",
                dob: "เคเคจเฅเคฎ เคคเคฟเคฅเคฟ",
                nationality: "เคฐเคพเคทเฅเคเฅเคฐเฅเคฏเคคเคพ",
                gender: "เคฒเคฟเคเค",
                issuing_date: "เคเคพเคฐเฅ เคเคฐเคจเฅ เคเฅ เคคเคฟเคฅเคฟ",
                expiry_date: "เคธเคฎเคพเคชเฅเคคเคฟ เคคเคฟเคฅเคฟ",
                issuing_place: "เคเคพเคฐเฅ เคเคฐเคจเฅ เคเคพ เคธเฅเคฅเคพเคจ",
                occupation: "เคชเฅเคถเคพ",
                sponsor: "เคธเฅเคชเฅเคจเฅเคธเคฐ",
                mobile: "เคฎเฅเคฌเคพเคเคฒ เคจเคเคฌเคฐ",
                salary_range_label: "เคเคฏ เคธเฅเคฎเคพ",
                found_plans: (n) => `เคเคเฅเคเฅ เคเคฌเคฐ! เคเคชเคเฅ เคฒเคฟเค ${n} เคฏเฅเคเฅเคฏ เคชเฅเคฒเคพเคจ เคฎเคฟเคฒเฅ เคนเฅเคเฅค เคเฅเคชเคฏเคพ เคเคเฅ เคฌเคขเคผเคจเฅ เคเฅ เคฒเคฟเค เคเค เคเฅเคจเฅเคเฅค`,
                no_plans: "เคฎเคพเคซเคผ เคเฅเคเคฟเค, เคเคชเคเฅ เคเคฏ เคเคฐ เคเคพเคฐเฅ เคธเฅเคฅเคพเคจ เคเฅ เคเคงเคพเคฐ เคชเคฐ เคเคญเฅ เคเฅเค เคเคจเคฒเคพเคเคจ เคชเฅเคฒเคพเคจ เคเคชเคฒเคฌเฅเคง เคจเคนเฅเค เคนเฅเฅค",
                eligible: "เคฏเฅเคเฅเคฏ",
                select_plan_msg: (name, type) => `เคฎเฅเค ${name} (${type}) เคชเฅเคฒเคพเคจ เคเฅเคจเคจเคพ เคเคพเคนเคคเคพ/เคเคพเคนเคคเฅ เคนเฅเคเฅค`,
                success_title: "เคธเคซเคฒเคคเคพ ๐",
                policy_active: "เคเคชเคเฅ เคชเฅเคฒเคฟเคธเฅ เคธเคเฅเคฐเคฟเคฏ เคนเฅ เคเค เคนเฅ",
                policy_no: "เคชเฅเคฒเคฟเคธเฅ เคจเคเคฌเคฐ",
                premium: "เคชเฅเคฐเฅเคฎเคฟเคฏเคฎ เคฐเคพเคถเคฟ",
                continue_btn: "เคเคพเคฐเฅ เคฐเคเฅเค",
                welcome_back: "เคตเคพเคชเคธเฅ เคชเคฐ เคธเฅเคตเคพเคเคค เคนเฅ! เคเคชเคเคพ เคชเคฟเคเคฒเคพ เคธเคคเฅเคฐ เคฌเคนเคพเคฒ เคเคฐ เคฆเคฟเคฏเคพ เคเคฏเคพ เคนเฅเฅค",
                continue_income: "เคเคนเคพเค เคธเฅ เคฐเฅเคเฅ เคฅเฅ, เคตเคนเฅเค เคธเฅ เคเคเฅ เคฌเคขเคผเคคเฅ เคนเฅเคเฅค เคเฅเคชเคฏเคพ เคเคฏ เคธเฅเคฎเคพ เคเฅเคจเฅเคเฅค",
                restart_prompt: "เคเคตเฅเคฆเคจ เคเคพเคฐเฅ เคฐเคเคจเฅ เคเฅ เคฒเคฟเค เคเคชเคฐ เคฆเคฟเค เคเค เคตเคฟเคเคฒเฅเคชเฅเค เคเคพ เคเคชเคฏเฅเค เคเคฐเฅเคเฅค",
                below_4000: "4000 AED เคธเฅ เคเคฎ",
                between_4000_5000: "4000 โ 5000 AED",
                above_5000: "5000 AED เคธเฅ เคเคงเคฟเค",
                reset_failed: "เคธเคคเฅเคฐ เคฐเฅเคธเฅเค เคจเคนเฅเค เคนเฅ เคธเคเคพเฅค เคเฅเคชเคฏเคพ เคฆเฅเคฌเคพเคฐเคพ เคชเฅเคฐเคฏเคพเคธ เคเคฐเฅเคเฅค",
                start_fresh_q: "เคซเคฟเคฐ เคธเฅ เคถเฅเคฐเฅ เคเคฐเฅเค?",
                start_fresh_msg: "เคเคธเคธเฅ เคเคชเคเฅ เคฎเฅเคเฅเคฆเคพ เคชเฅเคฐเคเคคเคฟ เคฎเคฟเค เคเคพเคเคเฅ เคเคฐ เคชเฅเคฐเคเฅเคฐเคฟเคฏเคพ เคฆเฅเคฌเคพเคฐเคพ เคถเฅเคฐเฅ เคนเฅเคเฅเฅค",
                upload_failed: "เคฆเคธเฅเคคเคพเคตเฅเคเคผ เคชเฅเคฐเฅเคธเฅเคธ เคจเคนเฅเค เคนเฅ เคธเคเคพเฅค เคเฅเคชเคฏเคพ เคซเคฟเคฐ เคธเฅ เคชเฅเคฐเคฏเคพเคธ เคเคฐเฅเคเฅค",
                upload_error: "เคฆเคธเฅเคคเคพเคตเฅเคเคผ เคเคชเคฒเฅเคก เคเคฐเคคเฅ เคธเคฎเคฏ เคคเฅเคฐเฅเคเคฟ เคนเฅเคเฅค",
                return_dashboard: "เคกเฅเคถเคฌเฅเคฐเฅเคก เคชเคฐ เคตเคพเคชเคธ เคเคพเคเค",
                verifying: "เคเคพเคจเคเคพเคฐเฅ เคธเคคเฅเคฏเคพเคชเคฟเคค เคเฅ เคเคพ เคฐเคนเฅ เคนเฅโฆ",
                sending: "เคญเฅเคเคพ เคเคพ เคฐเคนเคพ เคนเฅโฆ",
                connection_error_title: "เคเคจเฅเคเฅเคถเคจ เคธเคฎเคธเฅเคฏเคพ",
                connection_error_msg: "เคเฅเคชเคฏเคพ เคเคชเคจเคพ เคเคเคเคฐเคจเฅเค เคเคจเฅเคเฅเคถเคจ เคเคพเคเคเฅเค เคเคฐ เคซเคฟเคฐ เคเฅเคถเคฟเคถ เคเคฐเฅเคเฅค",
                logout_q: "เคฒเฅเค เคเคเค เคเคฐเฅเค?",
                logout_msg: "เคเฅเคฏเคพ เคเคช เคตเคพเคเค เคฒเฅเค เคเคเค เคเคฐเคจเคพ เคเคพเคนเคคเฅ เคนเฅเค?",
                exit_session_q: "เคธเคคเฅเคฐ เคธเคฎเคพเคชเฅเคค เคเคฐเฅเค?",
                exit_session_msg: "เคเคญเฅ เคฌเคพเคนเคฐ เคจเคฟเคเคฒเคจเฅ เคชเคฐ เคเคชเคเฅ เคชเฅเคฐเคเคคเคฟ เคเฅ เคธเคเคคเฅ เคนเฅเฅค",
                login_failed_title: "เคฒเฅเคเคฟเคจ เคเคธเคซเคฒ",
                req_missing: "เคเฅเค เคเคตเคถเฅเคฏเค เคเคพเคจเคเคพเคฐเฅ เคเคงเฅเคฐเฅ เคนเฅ",
                enter_otp: "เคเฅเคชเคฏเคพ เคเคชเคเฅ เคญเฅเคเคพ เคเคฏเคพ เคธเคคเฅเคฏเคพเคชเคจ เคเฅเคก เคฆเคฐเฅเค เคเคฐเฅเค",
                expired_doc_title: "เคฆเคธเฅเคคเคพเคตเฅเคเคผ เคเฅ เคเคตเคงเคฟ เคธเคฎเคพเคชเฅเคค",
                expired_doc_msg: "Emirates ID เคเฅ เคเคตเคงเคฟ เคธเคฎเคพเคชเฅเคค เคนเฅ เคเฅเคเฅ เคนเฅเฅค เคชเฅเคฐเคเฅเคฐเคฟเคฏเคพ เคเคเฅ เคจเคนเฅเค เคฌเคขเคผ เคธเคเคคเฅเฅค",
                missing_info: "เคเคพเคจเคเคพเคฐเฅ เคเคงเฅเคฐเฅ เคนเฅ",
                enter_mobile: "เคเฅเคชเคฏเคพ เคเค เคตเฅเคง เคฎเฅเคฌเคพเคเคฒ เคจเคเคฌเคฐ เคฆเคฐเฅเค เคเคฐเฅเคเฅค",
                review_details_title: "เคตเคฟเคตเคฐเคฃ เคเฅ เคธเคฎเฅเคเฅเคทเคพ เคเคฐเฅเค",
                eid_no: "Emirates ID เคจเคเคฌเคฐ",
                verification_title: "เคธเคคเฅเคฏเคพเคชเคจ",
                extracted_label: "ID เคธเฅ เคชเฅเคฐเคพเคชเฅเคค เคเคพเคจเคเคพเคฐเฅ",
                verify_notice: "เคเคธเฅเคตเฅเคเฅเคคเคฟ เคธเฅ เคฌเคเคจเฅ เคเฅ เคฒเคฟเค เคตเคฟเคตเคฐเคฃ Emirates ID เคธเฅ เคฎเคฟเคฒเคพเคจ เคเคฐเฅเคเฅค",
                confirm_btn: "เคชเฅเคทเฅเคเคฟ เคเคฐเฅเค เคเคฐ เคเคเฅ เคฌเคขเคผเฅเค",
                male: "เคชเฅเคฐเฅเคท",
                female: "เคฎเคนเคฟเคฒเคพ",
                mobile_number_label: "เคฎเฅเคฌเคพเคเคฒ เคจเคเคฌเคฐ",
                policy_info_label: "เคชเฅเคฒเคฟเคธเฅ เคเคพเคจเคเคพเคฐเฅ",
                user_details_label: "เคเคชเคฏเฅเคเคเคฐเฅเคคเคพ เคตเคฟเคตเคฐเคฃ",
                close_btn: "เคฌเคเคฆ เคเคฐเฅเค",
                ai_placeholder: "เคฌเฅเคฎเคพ เคเฅ เคฌเคพเคฐเฅ เคฎเฅเค เคเฅเค เคญเฅ เคชเฅเคเฅเค...",
                ai_welcome_msg: "เคจเคฎเคธเฅเคคเฅ! เคฎเฅเค เคเคชเคเคพ เคเคเคถเฅเคฏเฅเคฐเฅเคเคธ เคเคธเคฟเคธเฅเคเฅเคเค เคนเฅเคเฅค เคฎเฅเคเคธเฅ เคเคตเคฐเฅเค, เคเคเคชเคจเฅ เคตเคฟเคตเคฐเคฃ เคฏเคพ เคธเคนเคพเคฏเคคเคพ เคเฅ เคฌเคพเคฐเฅ เคฎเฅเค เคชเฅเคเฅเคเฅค",
                ai_thinking: "เคเคฟเคฏเคพ เคธเฅเค เคฐเคนเฅ เคนเฅ..."
            },
            ur: {
                welcome: "ุงูุดูุฑูุณ ุงุณุณูนููน ูฺบ ุฎูุด ุขูุฏุฏ ๐",
                select_lang: "ุจุฑุงู ฺฉุฑู ุงูพู ูพุณูุฏ ฺฉ ุฒุจุงู ููุชุฎุจ ฺฉุฑฺบ",
                looking_for_insurance: "ฺฉุง ุขูพ ุขุฌ ูฺฺฉู ุงูุดูุฑูุณ ููุง ฺุงุช ฺบุ",
                yes_start: "ุฌ ุงฺบุ ุดุฑูุน ฺฉุฑฺบ",
                no_cancel: "ูฺบุ ุจุนุฏ ูฺบ",
                cancel_msg: "ฺฉูุฆ ูุณุฆู ูฺบ ๐ ุฌุจ ุถุฑูุฑุช ู ูฺบ ุจุชุงุฆฺบ",
                employee_or_dependent: "ุดุฑูุน ฺฉุฑู ฺฉ ู ุจุชุงุฆฺบ โ ฺฉุง ุขูพ ููุงุฒู ฺบ ุง ุฒุฑู ฺฉูุงูุชุ",
                employee: "ููุงุฒู (Employee)",
                dependent: "ุฒุฑู ฺฉูุงูุช (Dependent)",
                income_self: "ุขูพ ฺฉ ูุงุงู ุขูุฏู ฺฉุชู ุ",
                income_sponsor: "ุขูพ ฺฉ ุงุณูพุงูุณุฑ ฺฉ ูุงุงู ุขูุฏู ฺฉุชู ุ",
                dependent_type_q: "ุขูพ ฺฉุณ ูุณู ฺฉ ุฒุฑู ฺฉูุงูุช ฺบุ",
                spouse: "ุดูุฑ / ุจู",
                child: "ุจฺ",
                upload_self: "ุขฺฏ ุจฺฺพู ฺฉ ู ุจุฑุงู ฺฉุฑู ุงูพู ุฏุฑุณุช Emirates ID ุงูพ ููฺ ฺฉุฑฺบ",
                upload_sponsor: "ุขฺฏ ุจฺฺพู ฺฉ ู ุจุฑุงู ฺฉุฑู ุงูพู ุงุณูพุงูุณุฑ ฺฉ Emirates ID ุงูพ ููฺ ฺฉุฑฺบ",
                btn_upload: "ุงุณฺฉู ฺฉุฑฺบ / ID ุงูพ ููฺ ฺฉุฑฺบ",
                uploading: "ID ุงูพ ููฺ ู ุฑ โฆ ุจุฑุงู ฺฉุฑู ุงูุชุธุงุฑ ฺฉุฑฺบ",
                review_details: "ุขฺฏ ุจฺฺพู ุณ ูพู ุงูพู ูุนูููุงุช ุบูุฑ ุณ ฺฺฉ ฺฉุฑฺบ",
                verified_details: "ุชุตุฏู ุดุฏ ูุนูููุงุช",
                name: "ูพูุฑุง ูุงู",
                eid: "Emirates ID",
                dob: "ุชุงุฑุฎู ูพุฏุงุฆุด",
                nationality: "ูููุช",
                gender: "ุฌูุณ",
                issuing_date: "ุงุฌุฑุงุก ฺฉ ุชุงุฑุฎ",
                expiry_date: "ูุนุงุฏ ุฎุชู ูู ฺฉ ุชุงุฑุฎ",
                issuing_place: "ุงุฌุฑุงุก ฺฉ ุฌฺฏ",
                occupation: "ูพุด",
                sponsor: "ุงุณูพุงูุณุฑ",
                mobile: "ููุจุงุฆู ููุจุฑ",
                salary_range_label: "ุขูุฏู ฺฉ ุญุฏ",
                found_plans: (n) => `ุฎูุดุฎุจุฑ! ุขูพ ฺฉ ู ${n} ุงู ูพูุงู ุฏุณุชุงุจ ฺบ ุจุฑุงู ฺฉุฑู ุงฺฉ ููุชุฎุจ ฺฉุฑฺบ`,
                no_plans: "ูุนุฐุฑุชุ ุขูพ ฺฉ ุขูุฏู ุงูุฑ ุงุฌุฑุงุก ฺฉ ุฌฺฏ ฺฉ ูุทุงุจู ุงุณ ููุช ฺฉูุฆ ุขู ูุงุฆู ูพูุงู ุฏุณุชุงุจ ูฺบ ",
                eligible: "ุงู",
                select_plan_msg: (name, type) => `ูฺบ ${name} (${type}) ูพูุงู ููุชุฎุจ ฺฉุฑูุง ฺุงุชุง/ฺุงุช ูฺบ`,
                success_title: "ฺฉุงูุงุจ ๐",
                policy_active: "ุขูพ ฺฉ ูพุงูุณ ูุนุงู ู ฺฏุฆ ",
                policy_no: "ูพุงูุณ ููุจุฑ",
                premium: "ูพุฑูู ุฑูู",
                continue_btn: "ุฌุงุฑ ุฑฺฉฺพฺบ",
                welcome_back: "ุฏูุจุงุฑ ุฎูุด ุขูุฏุฏ! ุขูพ ฺฉุง ูพฺฺพูุง ุณุดู ุจุญุงู ฺฉุฑ ุฏุง ฺฏุง ",
                continue_income: "ุฌุงฺบ ุณ ุขูพ ุฑฺฉ ุชฺพ ูฺบ ุณ ุขฺฏ ุจฺฺพุช ฺบ ุจุฑุงู ฺฉุฑู ุขูุฏู ฺฉ ุญุฏ ููุชุฎุจ ฺฉุฑฺบ",
                restart_prompt: "ุฏุฑุฎูุงุณุช ุฌุงุฑ ุฑฺฉฺพู ฺฉ ู ุงููพุฑ ุฏ ฺฏุฆ ุงุฎุชุงุฑุงุช ุงุณุชุนูุงู ฺฉุฑฺบ",
                below_4000: "4000 AED ุณ ฺฉู",
                between_4000_5000: "4000 โ 5000 AED",
                above_5000: "5000 AED ุณ ุฒุงุฏ",
                reset_failed: "ุณุดู ุฑ ุณูน ูฺบ ู ุณฺฉุง ุจุฑุงู ฺฉุฑู ุฏูุจุงุฑ ฺฉูุดุด ฺฉุฑฺบ",
                start_fresh_q: "ุฏูุจุงุฑ ุดุฑูุน ฺฉุฑฺบุ",
                start_fresh_msg: "ุงุณ ุณ ููุฌูุฏ ูพุด ุฑูุช ุฎุชู ู ุฌุงุฆ ฺฏ ุงูุฑ ุนูู ุฏูุจุงุฑ ุดุฑูุน ูฺฏุง",
                upload_failed: "ุฏุณุชุงูุฒ ูพุฑ ฺฉุงุฑุฑูุงุฆ ูฺบ ู ุณฺฉ ุจุฑุงู ฺฉุฑู ุฏูุจุงุฑ ฺฉูุดุด ฺฉุฑฺบ",
                upload_error: "ุฏุณุชุงูุฒ ุงูพ ููฺ ฺฉุฑุช ููุช ูุณุฆู ูพุด ุขุง",
                return_dashboard: "ฺุด ุจูุฑฺ ูพุฑ ูุงูพุณ ุฌุงุฆฺบ",
                verifying: "ูุนูููุงุช ฺฉ ุชุตุฏู ฺฉ ุฌุง ุฑ โฆ",
                sending: "ุจฺพุฌุง ุฌุง ุฑุง โฆ",
                connection_error_title: "ฺฉูฺฉุดู ฺฉุง ูุณุฆู",
                connection_error_msg: "ุจุฑุงู ฺฉุฑู ุงููนุฑููน ฺฉูฺฉุดู ฺฺฉ ฺฉุฑฺบ ุงูุฑ ุฏูุจุงุฑ ฺฉูุดุด ฺฉุฑฺบ",
                logout_q: "ูุงฺฏ ุขุคูน ฺฉุฑฺบุ",
                logout_msg: "ฺฉุง ุขูพ ูุงูุน ูุงฺฏ ุขุคูน ฺฉุฑูุง ฺุงุช ฺบุ",
                exit_session_q: "ุณุดู ุฎุชู ฺฉุฑฺบุ",
                exit_session_msg: "ุงุจฺพ ุจุงุฑ ูฺฉูู ุณ ุขูพ ฺฉ ูพุด ุฑูุช ุถุงุฆุน ู ุณฺฉุช ",
                login_failed_title: "ูุงฺฏ ุงูู ูุงฺฉุงู",
                req_missing: "ฺฉฺฺพ ุถุฑูุฑ ูุนูููุงุช ููุฌูุฏ ูฺบ ฺบ",
                enter_otp: "ุจุฑุงู ฺฉุฑู ุขูพ ฺฉู ุจฺพุฌุง ฺฏุง ุชุตุฏู ฺฉูฺ ุฏุฑุฌ ฺฉุฑฺบ",
                expired_doc_title: "ุฏุณุชุงูุฒ ฺฉ ูุนุงุฏ ุฎุชู",
                expired_doc_msg: "Emirates ID ฺฉ ูุนุงุฏ ุฎุชู ู ฺฺฉ  ุนูู ุฌุงุฑ ูฺบ ุฑฺฉฺพุง ุฌุง ุณฺฉุชุง",
                missing_info: "ูุนูููุงุช ูุงูฺฉูู ฺบ",
                enter_mobile: "ุจุฑุงู ฺฉุฑู ุฏุฑุณุช ููุจุงุฆู ููุจุฑ ุฏุฑุฌ ฺฉุฑฺบ",
                review_details_title: "ุชูุตูุงุช ฺฉุง ุฌุงุฆุฒ ูฺบ",
                eid_no: "Emirates ID ููุจุฑ",
                verification_title: "ุชุตุฏู",
                extracted_label: "ID ุณ ุญุงุตู ฺฉุฑุฏ ูุนูููุงุช",
                verify_notice: "ุฑุฏ ูู ุณ ุจฺู ฺฉ ู ุชุตุฏู ฺฉุฑฺบ ฺฉ ูุนูููุงุช ID ุณ ูุทุงุจูุช ุฑฺฉฺพุช ฺบ",
                confirm_btn: "ุชุตุฏู ฺฉุฑฺบ ุงูุฑ ุขฺฏ ุจฺฺพฺบ",
                male: "ูุฑุฏ",
                female: "ุนูุฑุช",
                mobile_number_label: "ููุจุงุฆู ููุจุฑ",
                policy_info_label: "ูพุงูุณ ฺฉ ูุนูููุงุช",
                user_details_label: "ุตุงุฑู ฺฉ ุชูุตูุงุช",
                close_btn: "ุจูุฏ ฺฉุฑฺบ",
                ai_placeholder: "ุงูุดูุฑูุณ ฺฉ ุจุงุฑ ูฺบ ฺฉฺฺพ ุจฺพ ูพูฺฺพฺบ...",
                ai_welcome_msg: "ูู! ูฺบ ุขูพ ฺฉุง ุงูุดูุฑูุณ ุงุณุณูนููน ูฺบ ูุฌฺพ ุณ ฺฉูุฑุฌุ ฺฉููพู ฺฉ ุชูุตูุงุชุ ุง ุณูพูุฑูน ฺฉ ุจุงุฑ ูฺบ ูพูฺฺพฺบ",
                ai_thinking: "ุงูุฑุง ุณูฺ ุฑ ..."
            }
        };

        function t(key, ...args) {
            const lang = state.insuranceData.lang || 'en';
            const dict = translations[lang] || translations.en;
            const val = dict[key] || translations.en[key] || key;
            if (typeof val === 'function') return val(...args);
            return val;
        }

        function isRTL() {
            const lang = state.insuranceData.lang || 'en';
            return ['ar', 'ur'].includes(lang);
        }

        // --- STATE ---
        const state = {
            user: null,
            mode: 'none', // 'insurance' or 'ai'
            insuranceData: {},
            chatHistory: [],
            aiChatHistory: [],
            policies: []
        };

        function getCurrentStream() {
            return state.mode === 'ai'
                ? document.getElementById('ai-chat-stream')
                : document.getElementById('chat-stream');
        }

        // --- COOKIE HELPER ---
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // --- API HELPER ---
        async function apiCall(endpoint, method = 'GET', data = null, isFileUpload = false) {
            const options = {
                method: method,
                credentials: 'include', // Important for cookies/session
                headers: {
                    'X-CSRFToken': getCookie('csrftoken') // Add CSRF Token
                }
            };

            if (data) {
                if (isFileUpload) {
                    options.body = data; // FormData content-type is auto-set
                } else {
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify(data);
                }
            }

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('API Error:', error);
                showAlert('error', t('connection_error_title'), t('connection_error_msg'));
                return { success: false, message: 'Network or Server Error' };
            }
        }

        // --- CUSTOM UI ALERTS ---
        let alertPromiseResolve = null;

        /**
         * Custom Alert System
         * @param {string} type - 'success', 'error', 'warning', 'info', 'confirm'
         */
        function showAlert(type, title, message, callback = null) {
            const modal = document.getElementById('modal-alert');
            const iconContainer = document.getElementById('alert-icon-container');
            const icon = document.getElementById('alert-icon');
            const titleEl = document.getElementById('alert-title');
            const msgEl = document.getElementById('alert-message');
            const accent = document.getElementById('alert-accent');
            const confirmBtn = document.getElementById('alert-btn-confirm');
            const cancelBtn = document.getElementById('alert-btn-cancel');

            // Reset
            cancelBtn.classList.add('hidden');
            confirmBtn.innerText = 'Okay';

            // Map types to styles
            const configs = {
                success: { icon: 'check', color: 'bg-emerald-500', iconColor: 'text-emerald-500', bg: 'bg-emerald-50', accent: 'bg-emerald-500' },
                error: { icon: 'x-circle', color: 'bg-red-500', iconColor: 'text-red-500', bg: 'bg-red-50', accent: 'bg-red-500' },
                warning: { icon: 'alert-triangle', color: 'bg-amber-500', iconColor: 'text-amber-500', bg: 'bg-amber-50', accent: 'bg-amber-500' },
                info: { icon: 'info', color: 'bg-brand-500', iconColor: 'text-brand-500', bg: 'bg-brand-50', accent: 'bg-brand-500' },
                confirm: { icon: 'help-circle', color: 'bg-brand-500', iconColor: 'text-brand-500', bg: 'bg-brand-50', accent: 'bg-brand-500' }
            };

            const config = configs[type] || configs.info;

            icon.setAttribute('data-lucide', config.icon);
            iconContainer.className = `w-16 h-16 rounded-2xl flex items-center justify-center mb-6 shadow-soft ${config.bg} ${config.iconColor}`;
            accent.className = `absolute top-0 left-0 w-full h-2 ${config.accent}`;
            titleEl.innerText = title;
            msgEl.innerText = message;

            if (type === 'confirm') {
                cancelBtn.classList.remove('hidden');
                confirmBtn.innerText = 'Confirm';
            }

            modal.classList.remove('hidden');
            document.body.classList.add('modal-open');
            lucide.createIcons();

            return new Promise((resolve) => {
                confirmBtn.onclick = () => {
                    modal.classList.add('hidden');
                    document.body.classList.remove('modal-open');
                    if (callback) callback(true);
                    resolve(true);
                };
                cancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                    document.body.classList.remove('modal-open');
                    if (callback) callback(false);
                    resolve(false);
                };
            });
        }

        // --- AUTH CHECK ---
        async function checkAuth() {
            const res = await apiCall('/auth/check/');
            if (res.authenticated) {
                state.user = res.user;
                showView('view-landing');
                fetchPolicies(); // Pre-fetch policies
            } else {
                showView('view-login');
            }
        }

        // --- NAVIGATION ---
        function showView(viewId) {
            // Hide all sections inside main
            document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden'));

            // Show requested view
            const view = document.getElementById(viewId);
            view.classList.remove('hidden');

            const header = document.getElementById('header');
            const backBtn = document.getElementById('backBtn');
            const title = document.getElementById('pageTitle');

            if (viewId === 'view-login') {
                header.classList.add('hidden');
            } else {
                header.classList.remove('hidden');
                header.classList.add('flex');

                if (viewId === 'view-landing') {
                    backBtn.classList.add('hidden');
                    title.innerText = 'DASHBOARD';
                } else {
                    backBtn.classList.remove('hidden');
                    if (viewId === 'view-chat-interface') {
                        title.innerText = state.mode === 'insurance' ? 'APPLICATION' : 'ASSISTANT';
                    }
                    else if (viewId === 'view-details') title.innerText = 'PORTFOLIO';
                    else title.innerText = 'DETAILS';
                }
                updateUserHeader();
            }

            // Scroll to top
            document.querySelector('main').scrollTop = 0;
            setTimeout(() => lucide.createIcons(), 50);
        }

        function updateUserHeader() {
            if (state.user) {
                // Determine display name
                let displayName = state.user.first_name
                    ? `${state.user.first_name} ${state.user.last_name || ''}`.trim()
                    : (state.user.email ? state.user.email.split('@')[0] : 'Guest');

                // Truncate if too long
                if (displayName.length > 15) displayName = displayName.substring(0, 12) + '...';

                // Initial for circle
                const initial = displayName.charAt(0).toUpperCase();

                const nameEl = document.getElementById('header-username');
                const initEl = document.getElementById('header-initials');

                if (nameEl) nameEl.innerText = displayName;
                if (initEl) initEl.innerText = initial;
            }
        }

        function goBack() {
            if (state.mode !== 'none') {
                showAlert('confirm', 'Exit Session?', 'Exit current session? Progress may be lost.', (confirmed) => {
                    if (confirmed) {
                        state.mode = 'none';
                        showView('view-landing');
                    }
                });
            } else {
                showView('view-landing');
            }
        }

        function goToLanding() {
            state.mode = 'none';
            showView('view-landing');
        }

        async function logout() {
            showAlert('confirm', t('logout_q'), t('logout_msg'), async (confirmed) => {
                if (confirmed) {
                    await apiCall('/auth/logout/', 'POST');
                    state.user = null;
                    showView('view-login');
                    resetLogin();
                }
            });
        }

        // --- LOGIN ---
        async function sendOTP() {
            const email = document.getElementById('emailInput').value;
            if (!email) {
                document.getElementById('emailInput').focus();
                return;
            }

            const btn = document.querySelector('button[onclick="sendOTP()"]');
            const originalText = btn.innerText;
            btn.innerText = t('sending');
            btn.disabled = true;

            const res = await apiCall('/auth/send-otp/', 'POST', { email });

            btn.innerText = originalText;
            btn.disabled = false;

            if (res.success) {
                document.getElementById('login-step-1').classList.add('hidden');
                document.getElementById('login-step-2').classList.remove('hidden');
                document.getElementById('login-step-2').classList.add('fade-in');
                // DEV TIP: Show OTP in alert or console for easier testing if returned
                if (res.otp) console.log("DEV OTP:", res.otp);
            } else {
                showAlert('error', t('login_failed_title'), res.message || 'Failed to send OTP');
            }
        }

        async function verifyOTP() {
            const email = document.getElementById('emailInput').value;
            const otp = document.getElementById('otpInput').value;

            if (!otp) {
                showAlert('warning', t('req_missing'), t('enter_otp'));
                return;
            }

            const btn = document.querySelector('button[onclick="verifyOTP()"]');
            const originalText = btn.innerText;
            btn.innerText = t('verifying');
            btn.disabled = true;

            const res = await apiCall('/auth/verify-otp/', 'POST', { email, otp_code: otp });

            btn.innerText = originalText;
            btn.disabled = false;

            if (res.success) {
                state.user = res.user;
                showView('view-landing');
                fetchPolicies();
            } else {
                showAlert('error', 'Verification Failed', res.message || 'Invalid OTP');
            }
        }

        function resetLogin() {
            document.getElementById('login-step-2').classList.add('hidden');
            document.getElementById('login-step-1').classList.remove('hidden');
            document.getElementById('emailInput').value = '';
            document.getElementById('otpInput').value = '';
        }

        // --- CHAT SYSTEM ---

        async function clearChatSession() {
            showAlert('confirm', t('start_fresh_q'), t('start_fresh_msg'), async (confirmed) => {
                if (!confirmed) return;

                // Call backend to reset session
                const res = await apiCall('/insurance/applications/reset_session/', 'POST');

                if (res.success) {
                    // Clear Local State
                    state.chatHistory = [];
                    state.insuranceData = {};

                    // Clear UI
                    clearChatUI();

                    // Restart Flow
                    if (state.mode === 'insurance') {
                        initFlow();
                    } else if (state.mode === 'ai') {
                        openAskAI();
                    }
                } else {
                    showAlert('error', t('reset_failed'), t('reset_failed'));
                }
            });
        }

        function clearChatUI() {
            document.getElementById('chat-stream').innerHTML = '';
            document.getElementById('chat-options-container').innerHTML = '';
            document.getElementById('chat-options-container').classList.add('hidden');
        }

        function addChatBubble(content, sender = 'bot', isHtml = false, delay = 0) {
            const container = getCurrentStream();
            if (!container) return Promise.resolve();

            // 1. Add to local state history
            const msgObj = { content, sender, isHtml, timestamp: new Date().toISOString() };
            if (state.mode === 'ai') {
                state.aiChatHistory.push(msgObj);
            } else {
                state.chatHistory.push(msgObj);
            }

            // 2. Sync to backend if we have an active application
            if (state.mode === 'insurance' && state.insuranceData.applicationId && sender !== 'system') {
                syncChatHistory();
            }

            return new Promise(resolve => {
                setTimeout(() => {
                    // Only remove typing indicator when bot is responding
                    if (sender !== 'user') {
                        const existingTyping = container.querySelector('.typing-indicator-box');
                        if (existingTyping) existingTyping.remove();
                    }

                    const div = document.createElement('div');
                    div.className = `chat-bubble ${sender === 'user' ? 'chat-user' : 'chat-bot'} fade-in mb-4`;
                    if (isRTL() && sender === 'bot') {
                        div.style.direction = 'rtl';
                    }

                    if (isHtml) div.innerHTML = content;
                    else div.innerText = content;

                    container.appendChild(div);
                    div.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    lucide.createIcons();
                    resolve();
                }, delay);
            });
        }

        async function syncChatHistory() {
            // Debounce or just send? For now just send.
            if (!state.insuranceData.applicationId) return;

            try {
                // We send the entire history or append? 
                // Django JSONField replaces by default. So we send full history.
                await apiCall(`/insurance/applications/${state.insuranceData.applicationId}/`, 'PATCH', {
                    chat_history: state.chatHistory
                });
            } catch (e) {
                console.error("Failed to sync chat", e);
            }
        }

        function renderChatHistoryFromState() {
            const container = document.getElementById('chat-stream');
            if (!container) return;

            container.innerHTML = ''; // Clear existing

            if (!Array.isArray(state.chatHistory)) {
                console.error("chatHistory is not an array:", state.chatHistory);
                state.chatHistory = [];
                return;
            }

            state.chatHistory.forEach(msg => {
                if (!msg || !msg.content) return;
                const div = document.createElement('div');
                div.className = `chat-bubble ${msg.sender === 'user' ? 'chat-user' : 'chat-bot'} fade-in mb-4`;
                if (isRTL() && msg.sender === 'bot') {
                    div.style.direction = 'rtl';
                }

                if (msg.isHtml) div.innerHTML = msg.content;
                else div.innerText = msg.content;
                container.appendChild(div);
            });

            // Scroll to bottom
            setTimeout(() => {
                if (container.lastChild) container.lastChild.scrollIntoView({ behavior: 'smooth' });
                lucide.createIcons();
            }, 100);
        }

        function showTyping() {
            const container = getCurrentStream();
            if (!container) return;

            // Remove existing one if any
            const existing = container.querySelector('.typing-indicator-box');
            if (existing) existing.remove();

            const div = document.createElement('div');
            // Premium glass style for the thinking indicator
            div.className = 'chat-bubble chat-bot fade-in mb-4 typing-indicator-box flex items-center justify-center py-3 px-5 border border-slate-100 shadow-soft';

            if (isRTL()) {
                div.style.direction = 'rtl';
            }

            // Universal Premium Animation (Gia)
            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="flex gap-1.5 relative">
                        <span class="w-2 h-2 bg-brand-500 rounded-full animate-bounce [animation-delay:-0.3s]"></span>
                        <span class="w-2 h-2 bg-brand-400 rounded-full animate-bounce [animation-delay:-0.15s]"></span>
                        <span class="w-2 h-2 bg-brand-300 rounded-full animate-bounce"></span>
                    </div>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.15em] animate-pulse">${t('ai_thinking')}</span>
                </div>
            `;

            container.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function setInputOptions(options, callbackName) {
            const container = document.getElementById('chat-options-container');
            container.innerHTML = '';
            container.classList.remove('hidden');

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'bg-white border border-slate-200 text-slate-700 py-3 px-6 rounded-full text-xs font-bold uppercase tracking-wider hover:bg-brand-500 hover:text-white hover:border-brand-500 transition-all shadow-sm active:scale-95 whitespace-nowrap';
                btn.innerText = opt.label;
                btn.onclick = () => window[callbackName](opt.value, opt.label);
                container.appendChild(btn);
            });

            const inputContainer = document.querySelector('.input-container-glass');
            inputContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function hideInputOptions() {
            document.getElementById('chat-options-container').classList.add('hidden');
        }

        async function handleManualSend() {
            const val = document.getElementById('chatInput').value;
            if (!val) return;

            document.getElementById('chatInput').value = '';

            if (state.mode === 'insurance') {
                await addChatBubble(val, 'user');
                setTimeout(() => addChatBubble(t('restart_prompt'), 'bot'), 600);
            }
        }

        function handleAiManualSend() {
            const val = document.getElementById('aiChatInput').value;
            if (!val) return;

            document.getElementById('aiChatInput').value = '';

            if (state.mode === 'ai') {
                processAIQuery(val);
            }
        }

        // --- INSURANCE FLOW ---
        function startInsuranceFlow() {
            state.mode = 'insurance';

            // Allow user to see overview first? Or check active?
            // Let's check active silently.
            document.getElementById('modal-guidelines').classList.remove('hidden');
            document.body.classList.add('modal-open');
        }

        function closeGuidelines() {
            document.getElementById('modal-guidelines').classList.add('hidden');
            document.body.classList.remove('modal-open');
            showView('view-chat-interface');
            clearChatUI();

            // Check for previous session to resume
            checkForActiveSession();
        }

        async function checkForActiveSession() {
            showTyping();

            try {
                const res = await apiCall('/insurance/applications/active/');

                // Remove typing indicator once we get a response
                const typing = document.querySelector('.typing-indicator-box');
                if (typing) typing.remove();

                if (res.success && res.application) {
                    console.log("Restoring session:", res.application.id);

                    // 1. Map backend data to frontend state
                    state.insuranceData = {
                        ...res.application,
                        applicationId: res.application.id,
                        lang: res.application.language,
                        type: res.application.application_type,
                        salary: res.application.salary_range,
                        eid: res.application.emirates_id,
                        name: res.application.full_name
                    };

                    // 2. Parse Chat History safely
                    let history = res.application.chat_history;
                    if (typeof history === 'string') {
                        try { history = JSON.parse(history); } catch (e) { history = []; }
                    }
                    state.chatHistory = Array.isArray(history) ? history : [];

                    // 3. Render and Resume
                    if (state.chatHistory.length > 0) {
                        renderChatHistoryFromState();
                        // Add a resume greeting ONLY if it wasn't the last message
                        const lastMsg = state.chatHistory[state.chatHistory.length - 1];
                        if (!lastMsg.content.includes("Welcome back")) {
                            addChatBubble("Welcome back! I've restored your previous session.", 'bot');
                        }

                        // Wait a beat before jumping to UI logic to ensure chat is visible
                        setTimeout(() => resumeFlowLogic(), 500);
                    } else {
                        initFlow();
                    }
                } else {
                    // No active session found
                    initFlow();
                }
            } catch (err) {
                console.error("Session check failed:", err);
                const typing = document.querySelector('.typing-indicator-box');
                if (typing) typing.remove();
                initFlow();
            }
        }

        function resumeFlowLogic() {
            const d = state.insuranceData;

            // Determine where we are based on missing data
            if (!d.salary_range) {
                // If we have app but no salary (maybe created early? or bug)
                // Just restart flow questions but skip creating app again
                addChatBubble(t('continue_income'), 'bot');
                askIncome(false);
                return;
            }

            if (d.status === 'Pending OCR' || (d.status === 'In Progress' && d.emirates_id_document)) {
                // Document uploaded and waiting for review
                addChatBubble(t('review_details'), 'bot');
                setTimeout(() => {
                    document.getElementById('view-review').classList.remove('hidden');
                    document.body.classList.add('modal-open');
                    renderReviewForm();
                }, 1000);
                return;
            }

            if (!d.emirates_id_document) {
                // Needs upload
                askUpload();
                return;
            }

            // Fallback
            addChatBubble(t('restart_prompt'), 'bot');
        }

        async function initFlow() {
            state.insuranceData = {};
            state.chatHistory = []; // Reset local history

            showTyping();
            setTimeout(async () => {
                await addChatBubble(t('welcome'));
                showTyping();
                setTimeout(async () => {
                    await addChatBubble(t('select_lang'));
                    setInputOptions([
                        { label: 'English', value: 'en' },
                        { label: 'Malayalam', value: 'ml' },
                        { label: 'Arabic', value: 'ar' },
                        { label: 'Hindi', value: 'hi' },
                        { label: 'Urdu', value: 'ur' }
                    ], 'handleLanguage');
                }, 800);
            }, 600);
        }

        window.handleLanguage = async (val, label) => {
            await addChatBubble(label, 'user');
            hideInputOptions();
            state.insuranceData.lang = val;

            showTyping();
            setTimeout(async () => {
                await addChatBubble(t('looking_for_insurance'));
                setInputOptions([
                    { label: t('yes_start'), value: 'yes' },
                    { label: t('no_cancel'), value: 'no' }
                ], 'handleStartConfirm');
            }, 1000);
        };

        window.handleStartConfirm = async (val, label) => {
            await addChatBubble(label, 'user');
            hideInputOptions();

            if (val === 'no') {
                await addChatBubble(t('cancel_msg'), 'bot');
                setTimeout(() => goToLanding(), 2000);
                return;
            }

            showTyping();
            setTimeout(async () => {
                await addChatBubble(t('employee_or_dependent'));
                setInputOptions([
                    { label: t('employee'), value: 'Employee' },
                    { label: t('dependent'), value: 'Dependent' }
                ], 'handleType');
            }, 1000);
        }

        window.handleType = async (val, label) => {
            await addChatBubble(label, 'user');
            hideInputOptions();
            state.insuranceData.type = val;

            if (val === 'Employee') {
                askIncome();
            } else {
                askDependentType();
            }
        }

        function askIncome(isSponsor = false) {
            const txt = isSponsor ? t('income_sponsor') : t('income_self');
            showTyping();
            setTimeout(() => {
                addChatBubble(txt);
                setInputOptions([
                    { label: t('below_4000'), value: '<4000' },
                    { label: t('between_4000_5000'), value: '4000-5000' },
                    { label: t('above_5000'), value: '>5000' }
                ], 'handleIncome');
            }, 1000);
        }

        function askDependentType() {
            showTyping();
            setTimeout(async () => {
                await addChatBubble(t('dependent_type_q'));
                setInputOptions([
                    { label: t('spouse'), value: 'Spouse' },
                    { label: t('child'), value: 'Child' }
                ], 'handleDepType');
            }, 1000);
        }

        window.handleDepType = async (val, label) => {
            await addChatBubble(label, 'user');
            hideInputOptions();
            state.insuranceData.depType = val;
            askIncome(true);
        }

        window.handleIncome = async (val, label) => {
            await addChatBubble(label, 'user');
            hideInputOptions();
            state.insuranceData.salary = val;

            // Create Application on Backend here to start tracking
            createInitialApplication();
        }

        async function createInitialApplication() {
            showTyping();

            const appData = {
                language: state.insuranceData.lang,
                application_type: state.insuranceData.type,
                dependent_type: state.insuranceData.depType || '',
                salary_range: state.insuranceData.salary,
                // Partial data - dummy values for required fields that come later
                emirates_id: 'TEMP-' + Date.now(),
                full_name: 'Pending Upload',
                expiry_date: '2099-12-31',
                nationality: 'Pending',
                gender: 'Male',
                issuing_place: 'Pending',
                mobile_number: '0000000000',
                status: 'In Progress'
            };

            const res = await apiCall('/insurance/applications/', 'POST', appData);

            if (res.id) {
                state.insuranceData.applicationId = res.id;
                askUpload();
            } else {
                console.error("Failed to create app", res);
                askUpload(); // Continue anyway, will handle error later
            }
        }

        function askUpload() {
            const txt = state.insuranceData.type === 'Dependent' ? t('upload_sponsor') : t('upload_self');
            // Remove typing from previous step if any
            const existingTyping = document.querySelector('.typing-indicator-box');
            if (existingTyping) existingTyping.remove();

            addChatBubble(txt);

            const container = document.getElementById('chat-options-container');
            container.innerHTML = '';
            container.classList.remove('hidden');

            const btn = document.createElement('button');
            btn.className = 'w-full md:w-auto btn-gold text-white py-4 px-8 rounded-full text-sm font-bold uppercase tracking-wider flex items-center justify-center gap-3 shadow-lg transition-all active:scale-95';
            btn.innerHTML = `<i data-lucide="scan-line" class="w-5 h-5"></i> ${t('btn_upload')}`;
            btn.onclick = () => simulateUpload(); // Opens file picker

            container.appendChild(btn);
            lucide.createIcons();
            document.querySelector('.input-container-glass').scrollIntoView({ behavior: 'smooth' });
        }

        function simulateUpload() {
            // Create hidden file input
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,application/pdf';

            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                addChatBubble(t('uploading'), 'user');
                hideInputOptions();
                showTyping();

                const formData = new FormData();
                formData.append('document', file);
                if (state.insuranceData.applicationId) {
                    formData.append('application_id', state.insuranceData.applicationId);
                }

                try {
                    const res = await apiCall('/insurance/process-ocr/', 'POST', formData, true);

                    if (res.success) {
                        state.insuranceData = {
                            ...state.insuranceData,
                            ...res.data,
                            eid: res.data.emirates_id, // Map backend keys to frontend state
                            name: res.data.full_name,
                            expiry: res.data.expiry_date,
                            issuingPlace: res.data.issuing_place
                        };

                        setTimeout(() => {
                            document.getElementById('view-review').classList.remove('hidden');
                            document.body.classList.add('modal-open');
                            renderReviewForm();
                        }, 500);
                    } else {
                        addChatBubble(t('upload_failed'), 'bot');
                    }

                } catch (err) {
                    addChatBubble(t('upload_error'), 'bot');
                }
            };

            input.click();
        }

        // --- OCR & REVIEW ---
        // processMockOCR removed - using backend

        function renderReviewForm() {
            const container = document.getElementById('review-form');
            const data = state.insuranceData;

            // Update UI Static elements
            document.getElementById('review-modal-subtitle').innerText = t('verification_title');
            document.getElementById('review-modal-title').innerText = t('review_details_title');
            document.getElementById('review-modal-badge').innerText = t('extracted_label');
            document.getElementById('review-modal-notice').innerHTML = `<i data-lucide="alert-triangle" class="w-4 h-4 flex-none"></i> ${t('verify_notice')}`;
            document.getElementById('review-modal-confirm').innerText = t('confirm_btn');

            const createField = (key, label, type = 'text', readonly = false) => `
                <div class="group">
                    <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-wider group-focus-within:text-brand-500 transition-colors">${label}</label>
                    <input type="${type}" id="review-${key}" value="${data[key] || ''}" ${readonly ? 'readonly' : ''} 
                    class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-sm text-slate-800 font-semibold focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 focus:outline-none transition-all ${readonly ? 'bg-slate-100 text-slate-500 cursor-not-allowed' : ''}">
                </div>
            `;

            const createSelect = (key, label, options) => `
                 <div class="group">
                    <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-wider group-focus-within:text-brand-500 transition-colors">${label}</label>
                    <div class="relative">
                        <select id="review-${key}" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-sm text-slate-800 font-semibold focus:border-brand-500 focus:ring-4 focus:ring-brand-500/10 focus:outline-none transition-all appearance-none">
                            ${options.map(o => `<option value="${o.value}" ${data[key] === o.value ? 'selected' : ''}>${o.label}</option>`).join('')}
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-4 top-4 w-4 h-4 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
            `;

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" ${isRTL() ? 'dir="rtl"' : ''}>
                    ${createField('name', t('name'))}
                    ${createField('eid', t('eid_no'), 'text', true)}
                    
                    ${createField('date_of_birth', t('dob'), 'date')}
                    ${createField('nationality', t('nationality'))}
                    
                    ${createField('issuing_date', t('issuing_date'), 'date')}
                    ${createField('expiry', t('expiry_date'), 'date')}
                    
                    ${createSelect('issuingPlace', t('issuing_place'), [
                { label: 'Dubai', value: 'Dubai' },
                { label: 'Abu Dhabi', value: 'Abu Dhabi' },
                { label: 'Sharjah', value: 'Sharjah' },
                { label: 'Ajman', value: 'Ajman' },
                { label: 'Fujairah', value: 'Fujairah' },
                { label: 'Ras Al Khaimah', value: 'Ras Al Khaimah' },
                { label: 'Umm Al Quwain', value: 'Umm Al Quwain' }
            ])}
                    ${createSelect('gender', t('gender'), [
                { label: t('male'), value: 'Male' },
                { label: t('female'), value: 'Female' }
            ])}
                    
                    <div class="md:col-span-2">
                         ${createField('occupation', t('occupation'))}
                    </div>
                    
                    <div class="md:col-span-2">
                         ${createField('sponsor_name', t('sponsor'))}
                    </div>
                    
                    <div class="group md:col-span-2">
                         <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-wider group-focus-within:text-brand-500 transition-colors">${t('mobile_number_label')}</label>
                         <div class="flex">
                            <span class="p-3.5 bg-slate-100 border border-r-0 border-slate-200 rounded-l-xl text-sm font-semibold text-slate-500">+971</span>
                            <input type="tel" id="review-mobile" placeholder="50 123 4567" value="${data.mobile_number || ''}" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-r-xl text-sm text-slate-800 font-semibold focus:border-brand-500 focus:border-l-slate-200 focus:ring-4 focus:ring-brand-500/10 focus:outline-none transition-all">
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        async function confirmReview() {
            // Harvest Data
            const data = state.insuranceData;

            // Map input values back to state
            data.name = document.getElementById('review-name').value;
            data.eid = document.getElementById('review-eid').value;
            data.date_of_birth = document.getElementById('review-date_of_birth').value;
            data.nationality = document.getElementById('review-nationality').value;
            data.issuing_date = document.getElementById('review-issuing_date').value;
            data.expiry = document.getElementById('review-expiry').value;

            data.issuingPlace = document.getElementById('review-issuingPlace').value;
            data.gender = document.getElementById('review-gender').value;

            data.occupation = document.getElementById('review-occupation').value;
            data.sponsor_name = document.getElementById('review-sponsor_name').value;
            data.mobile = document.getElementById('review-mobile').value;

            const expiryDate = new Date(data.expiry);
            const today = new Date();

            if (expiryDate < today) {
                showAlert('error', t('expired_doc_title'), t('expired_doc_msg'));
                return;
            }

            if (!data.mobile) {
                showAlert('warning', t('missing_info'), t('enter_mobile'));
                return;
            }

            // Close Modal
            document.getElementById('view-review').classList.add('hidden');
            document.body.classList.remove('modal-open');

            // Sync updated data to backend (Update application)
            if (data.applicationId) {
                const updateData = {
                    full_name: data.name,
                    date_of_birth: data.date_of_birth,
                    issuing_date: data.issuing_date,
                    expiry_date: data.expiry,
                    nationality: data.nationality,
                    issuing_place: data.issuingPlace,
                    gender: data.gender,
                    occupation: data.occupation,
                    sponsor_name: data.sponsor_name,
                    mobile_number: data.mobile,
                    status: 'Pending OCR' // Keep as pending until product selection or move to 'Under Review'
                };

                // We send PATCH to update the application with reviewed details
                try {
                    await apiCall(`/insurance/applications/${data.applicationId}/`, 'PATCH', updateData);
                } catch (e) {
                    console.error("Auto-save failed", e);
                }
            }

            // Resume Chat
            presentConfirmedDataInChat();
        }

        function presentConfirmedDataInChat() {
            const d = state.insuranceData;
            const html = `
                <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm w-full md:min-w-[300px]" ${isRTL() ? 'dir="rtl"' : ''}>
                    <div class="flex items-center gap-2 mb-3 border-b border-slate-100 pb-2">
                        <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
                        <span class="text-xs font-bold text-slate-900 uppercase">${t('verified_details')}</span>
                    </div>
                    <div class="space-y-2 text-xs text-slate-600">
                        <div class="flex justify-between"><span>${t('name')}:</span> <span class="font-bold text-slate-800 text-right">${d.name}</span></div>
                        <div class="flex justify-between"><span>${t('eid')}:</span> <span class="font-mono text-slate-500 text-right">${d.eid}</span></div>
                        <div class="flex justify-between"><span>${t('dob')}:</span> <span class="text-right">${d.date_of_birth || '-'}</span></div>
                        <div class="flex justify-between"><span>${t('nationality')}:</span> <span class="text-right">${d.nationality || '-'}</span></div>
                        <div class="flex justify-between"><span>${t('gender')}:</span> <span class="text-right">${d.gender || '-'}</span></div>
                        <div class="flex justify-between"><span>${t('issuing_date')}:</span> <span class="text-right">${d.issuing_date || '-'}</span></div>
                        <div class="flex justify-between"><span>${t('expiry_date')}:</span> <span class="text-right">${d.expiry || '-'}</span></div>
                        <div class="flex justify-between"><span>${t('issuing_place')}:</span> <span class="text-right">${d.issuingPlace || '-'}</span></div>
                        <div class="flex justify-between"><span>${t('occupation')}:</span> <span class="text-right truncate max-w-[150px]">${d.occupation || '-'}</span></div>
                        <div class="flex justify-between"><span>${t('sponsor')}:</span> <span class="text-right truncate max-w-[150px]">${d.sponsor_name || '-'}</span></div>
                        <div class="flex justify-between"><span>${t('mobile')}:</span> <span class="text-right">${d.mobile || '-'}</span></div>
                        <div class="flex justify-between mt-2 pt-2 border-t border-slate-50 text-slate-800 font-bold"><span>${t('salary_range_label')}:</span> <span>${d.salary} AED</span></div>
                    </div>
                </div>
            `;

            addChatBubble(html, 'bot', true);
            setTimeout(() => lucide.createIcons(), 100);

            showTyping();
            setTimeout(() => {
                calculateAndShowProducts();
            }, 1500);
        }

        async function calculateAndShowProducts() {
            const place = state.insuranceData.issuingPlace;
            const salary = state.insuranceData.salary;

            // Backend Call for Recommendations
            const res = await apiCall('/insurance/recommendations/', 'POST', {
                salary_range: salary,
                issuing_place: place
            });

            if (res.success && res.products.length > 0) {
                const plans = res.products;

                await addChatBubble(t('found_plans', plans.length), 'bot');

                // Show Products in Chat Stream
                setTimeout(() => {
                    const container = document.getElementById('chat-stream');
                    const cardsContainer = document.createElement('div');
                    cardsContainer.className = 'flex flex-col md:flex-row gap-4 mt-2 fade-in mb-4 w-full md:w-auto';

                    plans.forEach((plan, index) => {
                        const card = document.createElement('div');
                        card.className = 'bg-white border border-slate-200 p-5 rounded-[20px] shadow-sm hover:shadow-md hover:border-brand-500 transition-all cursor-pointer flex-1 md:min-w-[260px] group';
                        // Map backend fields to frontend logic
                        const planData = {
                            name: plan.plan_name,
                            type: plan.plan_type,
                            price: plan.premium_amount
                        };
                        card.onclick = () => selectProduct(planData);

                        card.innerHTML = `
                            <div class="flex justify-between items-start mb-4" ${isRTL() ? 'dir="rtl"' : ''}>
                                <div class="${isRTL() ? 'text-right' : ''}">
                                    <h4 class="font-bold text-lg text-slate-800">${plan.plan_name}</h4>
                                    <span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded mt-1 inline-block group-hover:bg-brand-50 group-hover:text-brand-600 transition-colors">${plan.plan_type}</span>
                                </div>
                                <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center group-hover:bg-brand-500 transition-colors">
                                    <i data-lucide="arrow-right" class="w-4 h-4 text-slate-400 group-hover:text-white ${isRTL() ? 'rotate-180' : ''}"></i>
                                </div>
                            </div>
                            <div class="text-2xl font-bold text-slate-900 mb-1 ${isRTL() ? 'text-right' : ''}"><span class="text-sm font-medium text-slate-400">AED</span> ${plan.premium_amount}</div>
                            <div class="text-[10px] text-green-600 font-bold uppercase tracking-wide flex items-center gap-1 ${isRTL() ? 'justify-end' : ''}">
                                <i data-lucide="check" class="w-3 h-3"></i> ${t('eligible')}
                            </div>
                        `;
                        cardsContainer.appendChild(card);
                    });

                    container.appendChild(cardsContainer);
                    lucide.createIcons();
                    cardsContainer.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 800);
            } else {
                addChatBubble(t('no_plans'), 'bot');
                setTimeout(() => {
                    const btnHtml = `<button onclick="goToLanding()" class="text-xs text-brand-500 font-bold underline">${t('return_dashboard')}</button>`;
                    addChatBubble(btnHtml, 'bot', true);
                }, 1000);
            }
        }

        // Product Selection Logic
        async function selectProduct(plan) {
            await addChatBubble(t('select_plan_msg', plan.name, plan.type), 'user');
            showTyping();

            setTimeout(() => {
                finalizeInsurance(plan);
            }, 1000);
        }

        async function finalizeInsurance(plan) {
            // Call Backend Create Policy
            const payload = {
                application_id: state.insuranceData.applicationId,
                plan_name: plan.name,
                plan_type: plan.type,
                premium_amount: plan.price
            };

            const res = await apiCall('/insurance/create-policy/', 'POST', payload);

            if (res.success) {
                const policy = res.policy;

                // Success Card
                const successHtml = `
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-[24px] p-6 text-white shadow-lg w-full md:min-w-[320px]" ${isRTL() ? 'dir="rtl"' : ''}>
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                                <i data-lucide="check" class="w-6 h-6 text-white"></i>
                            </div>
                            <div class="${isRTL() ? 'text-right' : ''}">
                                <h3 class="font-bold text-lg">${t('success_title')}</h3>
                                <p class="text-xs text-white/80">${t('policy_active')}</p>
                            </div>
                        </div>
                        <div class="bg-white/10 rounded-xl p-4 backdrop-blur-sm mb-4">
                            <div class="flex justify-between text-sm mb-1"><span>${t('policy_no')}:</span> <span class="font-mono font-bold">${policy.policy_number}</span></div>
                            <div class="flex justify-between text-sm"><span>${t('premium')}:</span> <span class="font-bold">AED ${policy.premium_amount}</span></div>
                        </div>
                        <button onclick="window.location.href='#'" class="w-full bg-white text-emerald-600 font-bold py-3 rounded-xl text-xs uppercase tracking-wider hover:bg-emerald-50 transition-colors">
                            ${t('continue_btn')}
                        </button>
                    </div>
                `;

                addChatBubble(successHtml, 'bot', true);
                setTimeout(() => lucide.createIcons(), 100);

                // Refresh policies
                fetchPolicies();
            } else {
                addChatBubble("Policy creation failed: " + res.message, 'bot');
            }
        }


        // --- ASK AI ---
        function openAskAI() {
            state.mode = 'ai';
            showView('view-ai-chat');

            // Set Placeholder
            document.getElementById('aiChatInput').placeholder = t('ai_placeholder');

            if (state.aiChatHistory.length === 0) {
                addChatBubble(t('ai_welcome_msg'));
            } else {
                renderAiChatHistoryFromState();
            }
        }

        function clearAiChatUI() {
            const stream = document.getElementById('ai-chat-stream');
            if (stream) stream.innerHTML = '';
        }

        function renderAiChatHistoryFromState() {
            const container = document.getElementById('ai-chat-stream');
            if (!container) return;

            container.innerHTML = '';
            state.aiChatHistory.forEach(msg => {
                const div = document.createElement('div');
                div.className = `chat-bubble ${msg.sender === 'user' ? 'chat-user' : 'chat-bot'} fade-in mb-4`;
                if (isRTL() && msg.sender === 'bot') div.style.direction = 'rtl';
                if (msg.isHtml) div.innerHTML = msg.content;
                else div.innerText = msg.content;
                container.appendChild(div);
            });

            setTimeout(() => {
                if (container.lastChild) container.lastChild.scrollIntoView({ behavior: 'smooth' });
                lucide.createIcons();
            }, 100);
        }

        async function processAIQuery(txt) {
            const container = document.getElementById('ai-chat-stream');
            await addChatBubble(txt, 'user');

            showTyping();

            const currentLang = state.insuranceData.lang || 'en';
            const apiKey = 'pk_9YXqUpDSFMMu9eXh';

            // Build Real-time Context
            const appStatus = state.insuranceData.status || 'Not started';
            const policyCount = state.policies.length;
            const userName = state.user ? state.user.full_name : 'Guest';

            const systemPrompt = `You are "Aura", the premium AI Guide for the Medical Insurance Portal.
            Your purpose is to assist users like ${userName} with medical insurance applications and support.
            
            CURRENT CONTEXT:
            - User Name: ${userName}
            - Current Application Status: ${appStatus}
            - Number of Active Policies: ${policyCount}
            - Preferred Language: ${currentLang}

            OUR PRODUCTS (DHA COMPLIANT):
            - DHA Basic (LSB): For low salary brackets (< 4000 AED). Premium: 864 AED.
            - DHA Basic (NLSB): For non-low salary brackets (>= 4000 AED). Premium: 1893 AED.

            STRICT APP RULES:
            1. Respond ONLY regarding this medical insurance portal. Avoid general life/technical advice.
            2. For Father/Family insurance: Explain they can start a new journey for them by selecting "Dependent" as the application type.
            3. Insurance Flow: (1) Language -> (2) Income/Type -> (3) Emirates ID Scan -> (4) Review -> (5) Plan Selection -> (6) Payment.
            4. If the user asks general questions, politely redirect them back to insurance topics.
            5. ALWAYS use the ${currentLang} language.

            ACTIONABLE BUTTONS (Include these tags for key moments):
            - To start a new/father's application: [[BUTTON:${t('yes_start')}|action:flow]]
            - To go to Dashboard: [[BUTTON:${t('return_dashboard')}|action:landing]]
            - To view current policies: [[BUTTON:${t('user_details_label')}|action:portfolio]]

            Format: Use professional headers, bullet points, and emojis (๐ก๏ธ, ๐, โ).`;

            // Prep messages for Chat Completions (OpenAI style)
            const messages = [
                { role: "system", content: systemPrompt }
            ];

            // Add history (limit to last 10 for context window efficiency)
            const history = state.aiChatHistory.slice(-10).map(msg => ({
                role: msg.sender === 'user' ? 'user' : 'assistant',
                content: msg.content
            }));
            messages.push(...history);

            try {
                const response = await fetch(`https://gen.pollinations.ai/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'openai-fast',
                        messages: messages,
                        seed: Math.floor(Math.random() * 1000)
                    })
                });

                if (!response.ok) throw new Error("API Connection Issue");

                const data = await response.json();
                const replyText = data.choices[0].message.content;

                // Parse and render
                const htmlResponse = parseAiResponse(replyText);
                addChatBubble(htmlResponse, 'bot', true);
            } catch (error) {
                console.error("AI Error:", error);
                const fallback = `I'm currently undergoing maintenance, but I can still help you start your journey: <br><br> [[BUTTON:${t('yes_start')}|action:flow]]`;
                addChatBubble(parseAiResponse(fallback), 'bot', true);
            }
        }

        function parseAiResponse(text) {
            // Bold markdown
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Bullet points (handle multi-line blocks)
            const lines = html.split('\n');
            let result = [];
            let inList = false;

            lines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed.startsWith('- ') || trimmed.startsWith('* ')) {
                    if (!inList) {
                        result.push('<ul class="my-2 space-y-1">');
                        inList = true;
                    }
                    result.push(`<li class="ml-4 list-disc text-slate-600 font-medium text-xs md:text-sm">${trimmed.substring(2)}</li>`);
                } else {
                    if (inList) {
                        result.push('</ul>');
                        inList = false;
                    }
                    if (trimmed) result.push(`<div class="mb-1">${line}</div>`);
                    else result.push('<div class="h-2"></div>'); // Spacer for empty lines
                }
            });
            if (inList) result.push('</ul>');

            html = result.join('');

            // Parse Buttons: [[BUTTON:Label|Action]]
            html = html.replace(/\[\[BUTTON:(.*?)\|(.*?)\]\]/g, (match, label, action) => {
                let onclick = '';
                if (action === 'action:flow') onclick = 'startInsuranceFlow()';
                else if (action === 'action:landing') onclick = 'goToLanding()';
                else if (action === 'action:portfolio') onclick = 'showDetails()';

                return `
                    <button onclick="${onclick}" class="mt-3 w-full bg-brand-500 text-white py-3 px-4 rounded-xl text-xs font-bold uppercase tracking-wider hover:bg-brand-600 transition-all shadow-md active:scale-95 flex items-center justify-center gap-2">
                        ${label} <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                `;
            });

            return html;
        }

        // --- FETCH POLICIES ---
        async function fetchPolicies() {
            const res = await apiCall('/insurance/policies/active/');
            if (res.success && res.policies) {
                state.policies = res.policies; // array of policy objects
            }
        }

        // --- DETAILS ---
        function showDetails() {
            showView('view-details');
            const list = document.getElementById('policies-list');
            list.innerHTML = '';

            if (state.policies.length === 0) {
                document.getElementById('no-policies').classList.remove('hidden');
                return;
            } else {
                document.getElementById('no-policies').classList.add('hidden');
            }

            state.policies.forEach(p => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 md:p-8 rounded-[24px] shadow-sm border border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-4 hover:shadow-md hover:border-brand-300 transition-all cursor-pointer group';
                card.onclick = () => viewPolicyDetails(p.id);
                card.innerHTML = `
                    <div class="flex gap-4 items-start">
                        <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center flex-none text-blue-600 group-hover:bg-brand-500 group-hover:text-white transition-colors">
                            <i data-lucide="shield" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <div class="text-[10px] text-slate-400 font-bold font-mono uppercase tracking-widest mb-1 group-hover:text-brand-500 transition-colors">${p.policy_number}</div>
                            <h3 class="text-base font-bold text-slate-900">${p.plan_name} <span class="text-xs font-normal text-slate-500 bg-slate-100 px-2 py-0.5 rounded ml-2">${p.plan_type}</span></h3>
                            <p class="text-sm text-slate-500 mt-1 font-medium">Insured: ${p.insured_name}</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between md:flex-col md:items-end md:justify-center border-t md:border-0 border-slate-100 pt-4 md:pt-0">
                        <div class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-green-50 text-green-700 text-[10px] font-bold uppercase tracking-wide border border-green-100">
                            <div class="w-2 h-2 rounded-full bg-green-500"></div> ${p.status}
                        </div>
                        <div class="text-xs text-slate-400 mt-0 md:mt-2 font-medium flex items-center gap-2">
                            <span>${new Date(p.issue_date).toLocaleDateString()}</span>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300 group-hover:translate-x-1 group-hover:text-brand-500 transition-all"></i>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
            lucide.createIcons();
        }

        function viewPolicyDetails(policyId) {
            const policy = state.policies.find(p => p.id === policyId);
            if (!policy || !policy.application) return;

            const app = policy.application;
            const container = document.getElementById('policy-detail-container');

            // Update Titles
            document.getElementById('policy-detail-subtitle').innerText = t('policy_info_label');
            document.getElementById('policy-detail-title').innerText = t('user_details_label');
            document.querySelector('#view-policy-details button[onclick="closePolicyDetails()"]:last-child').innerText = t('close_btn');

            const createField = (label, value) => `
                <div class="group py-3 border-b border-slate-50 last:border-0">
                    <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wider">${label}</label>
                    <div class="text-sm text-slate-800 font-semibold">${value || '-'}</div>
                </div>
            `;

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2" ${isRTL() ? 'dir="rtl"' : ''}>
                    ${createField(t('name'), app.full_name)}
                    ${createField(t('eid'), app.emirates_id)}
                    
                    ${createField(t('dob'), app.date_of_birth)}
                    ${createField(t('nationality'), app.nationality)}
                    
                    ${createField(t('gender'), app.gender)}
                    ${createField(t('issuing_place'), app.issuing_place)}
                    
                    ${createField(t('issuing_date'), app.issuing_date)}
                    ${createField(t('expiry_date'), app.expiry_date)}
                    
                    <div class="md:col-span-2">
                        ${createField(t('occupation'), app.occupation)}
                    </div>
                    
                    <div class="md:col-span-2">
                        ${createField(t('sponsor'), app.sponsor_name)}
                    </div>

                    <div class="md:col-span-2">
                        ${createField(t('mobile'), app.mobile_number)}
                    </div>
                </div>
                
                <div class="mt-6 pt-6 border-t border-slate-100">
                    <div class="text-[10px] font-bold text-brand-500 uppercase tracking-[0.2em] mb-4">Official Record</div>
                    <div class="bg-slate-50 rounded-2xl p-4 flex items-center justify-between border border-slate-100">
                        <div>
                            <div class="text-[10px] text-slate-400 font-bold uppercase">Plan Type</div>
                            <div class="text-sm font-bold text-slate-800">${policy.plan_name} (${policy.plan_type})</div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] text-slate-400 font-bold uppercase">Premium Paid</div>
                            <div class="text-sm font-bold text-brand-600">AED ${policy.premium_amount}</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('view-policy-details').classList.remove('hidden');
            document.body.classList.add('modal-open');
            lucide.createIcons();
        }

        function closePolicyDetails() {
            document.getElementById('view-policy-details').classList.add('hidden');
            document.body.classList.remove('modal-open');
        }

        // Check auth on load
        window.addEventListener('DOMContentLoaded', checkAuth);

        // Removed showView('view-login') here because checkAuth handles it
    </script>
</body>

</html>